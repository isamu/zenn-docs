---
title: "Context Management 2025 - 01. Context Management ã®é€²åŒ–"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [agent, AI, LLM, Tech]
published: true
publication_name: "singularity"
---

**2024-2025å¹´ã«ãŠã‘ã‚‹Context Managementï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†ï¼‰ã®é€²åŒ–**ã¨ã€ãã‚Œã«åŸºã¥ã**ãƒ¢ãƒ€ãƒ³ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ**ã«é–¢ã™ã‚‹åŒ…æ‹¬çš„ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

Roo Codeã€Anthropic Claudeã€ãŠã‚ˆã³æœ€æ–°ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¨­è¨ˆã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰æŠ½å‡ºã—ãŸãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’çµ±åˆã—ã¦ã„ã¾ã™ã€‚

# 01. Context Management ã®é€²åŒ– (2023-2024 â†’ 2025)

## ã¯ã˜ã‚ã«

2023-2024å¹´ã®LLMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€æ¯”è¼ƒçš„å˜ç´”ãªContext Managementï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†ï¼‰ã§å‹•ä½œã—ã¦ã„ã¾ã—ãŸã€‚ã—ã‹ã—ã€ä»¥ä¸‹ã®èª²é¡ŒãŒé¡•åœ¨åŒ–ã—ã¾ã—ãŸï¼š

- **é•·æœŸã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã®æƒ…å ±æå¤±**: å¤ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã™ã‚‹ã¨é‡è¦ãªæ–‡è„ˆãŒå¤±ã‚ã‚Œã‚‹
- **ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã¸ã®æ©Ÿæ¢°çš„å¯¾å¿œ**: ã—ãã„å€¤ã‚’è¶…ãˆãŸã‚‰å…ˆé ­ã‹ã‚‰å‰Šé™¤ã™ã‚‹ã ã‘
- **å¾©å…ƒä¸å¯èƒ½**: ä¸€åº¦å‰Šé™¤ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯æˆ»ã›ãªã„
- **ãƒ„ãƒ¼ãƒ«ã®ç„¡ç§©åº**: ã™ã¹ã¦ã®ãƒ„ãƒ¼ãƒ«ãŒå¸¸ã«è¦‹ãˆã‚‹çŠ¶æ…‹
- **ãƒ—ãƒ­ãƒˆã‚³ãƒ«éå¯¾å¿œ**: Native Toolsãªã©ã®æ–°ã—ã„ä»•æ§˜ã«å¯¾å¿œã§ããªã„

2024å¹´å¾ŒåŠã‹ã‚‰2025å¹´ã«ã‹ã‘ã¦ã€**Context Engineering**ã¨ã„ã†æ¦‚å¿µãŒç¢ºç«‹ã•ã‚Œã€ã‚ˆã‚Šé«˜åº¦ã§æŸ”è»Ÿãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒæ¨™æº–ã«ãªã‚Šã¾ã—ãŸã€‚

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€ã“ã®1å¹´é–“ã®é€²åŒ–ã‚’7ã¤ã®ãƒã‚¤ãƒ³ãƒˆã«åˆ†ã‘ã¦è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚

---

## 1å¹´å‰ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```typescript
// 2023-2024å¹´ã®å…¸å‹çš„ãªå®Ÿè£…
interface OldContextManagement {
  // ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã‚’ãã®ã¾ã¾é…åˆ—ã§ä¿æŒ
  messages: Message[]

  // åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ä¸€è¦§ï¼ˆé™çš„ï¼‰
  tools: Tool[]

  // è¨­å®š
  config: {
    maxMessages: number      // æœ€å¤§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ï¼ˆä¾‹: 100ï¼‰
    contextWindow: number    // ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ï¼ˆä¾‹: 4096ï¼‰
  }
}

class SimpleContextManager {
  private messages: Message[] = []

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
  addMessage(message: Message) {
    this.messages.push(message)

    // ä¸Šé™ãƒã‚§ãƒƒã‚¯ï¼ˆå˜ç´”ï¼‰
    if (this.messages.length > this.config.maxMessages) {
      // å¤ã„ã‚‚ã®ã‹ã‚‰å‰Šé™¤
      this.messages.shift()  // âŒ æ°¸ä¹…ã«å¤±ã‚ã‚Œã‚‹
    }
  }

  // APIé€ä¿¡ç”¨
  getMessages(): Message[] {
    return this.messages  // ãã®ã¾ã¾è¿”ã™
  }

  // ãƒ„ãƒ¼ãƒ«å–å¾—
  getTools(): Tool[] {
    return this.tools  // å¸¸ã«åŒã˜
  }
}
```

### å•é¡Œç‚¹

#### 1. æƒ…å ±ã®æ°¸ä¹…çš„ãªæå¤±

```typescript
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒ100ä»¶ã‚’è¶…ãˆã‚‹ã¨...
messages.length = 101

// æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
messages.shift()  // âŒ ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æ°¸ä¹…ã«å¤±ã‚ã‚Œã‚‹

// çµæœ: é‡è¦ãªæ–‡è„ˆæƒ…å ±ãŒæ¶ˆãˆã‚‹
// - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸè¦ä»¶
// - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é‡è¦ãªæŒ‡ç¤º
// - éå»ã®æ±ºå®šäº‹é …
```

#### 2. ãƒˆãƒ¼ã‚¯ãƒ³ã‚«ã‚¦ãƒ³ãƒˆã®ä¸æ­£ç¢ºã•

```typescript
// å˜ç´”ãªã‚«ã‚¦ãƒ³ãƒˆ
const tokenCount = messages.reduce(
  (sum, msg) => sum + msg.content.length / 4,  // âŒ ç²—ã„æ¨å®š
  0
)

// å•é¡Œ:
// - å®Ÿéš›ã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã¨å¤§ãããšã‚Œã‚‹
// - tool_use/tool_resultã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’è€ƒæ…®ã—ã¦ã„ãªã„
// - ç”»åƒã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ãŒä¸æ­£ç¢º
```

#### 3. å¾©å…ƒä¸å¯èƒ½

```typescript
// ç·¨é›†ã‚„å‰Šé™¤
messages = messages.filter(msg => msg.id !== deleteId)  // âŒ

// å•é¡Œ:
// - èª¤ã£ã¦å‰Šé™¤ã—ãŸã‚‰æˆ»ã›ãªã„
// - ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã§ããªã„
// - ãƒ‡ãƒãƒƒã‚°ãŒå›°é›£
```

#### 4. ãƒ„ãƒ¼ãƒ«ã®ç„¡ç§©åº

```typescript
const tools = [
  readFileTool,
  writeFileTool,
  deleteFileTool,     // âŒ å¸¸ã«è¦‹ãˆã‚‹ï¼ˆå±é™ºï¼‰
  executeTool,        // âŒ å¸¸ã«è¦‹ãˆã‚‹ï¼ˆå±é™ºï¼‰
  searchTool,
  analyzeTool
]

// å•é¡Œ:
// - ãƒ•ã‚§ãƒ¼ã‚ºã«é–¢ä¿‚ãªãå…¨ãƒ„ãƒ¼ãƒ«ãŒè¦‹ãˆã‚‹
// - æ¨©é™ãƒã‚§ãƒƒã‚¯ãªã—
// - èª¤æ“ä½œã®ãƒªã‚¹ã‚¯
// - ãƒˆãƒ¼ã‚¯ãƒ³ã®ç„¡é§„
```

---

## 7ã¤ã®ä¸»è¦ãªé€²åŒ–

### é€²åŒ–1: éç ´å£Šçš„ç®¡ç† â†’ ãƒ‡ãƒ¼ã‚¿æå¤±ã‚¼ãƒ­

#### Before: ç‰©ç†å‰Šé™¤

```typescript
// å¤ã„æ–¹æ³•: å‰Šé™¤ã—ãŸã‚‰æˆ»ã›ãªã„
class OldManager {
  deleteOldMessages(cutoff: number) {
    this.messages = this.messages.filter(
      msg => msg.timestamp > cutoff
    )
    // âŒ å‰Šé™¤ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æ°¸ä¹…ã«å¤±ã‚ã‚Œã‚‹
  }
}
```

#### After: ã‚¿ã‚°ä»˜ã‘ç®¡ç†

```typescript
// æ–°ã—ã„æ–¹æ³•ï¼ˆRoo Codeæ–¹å¼ï¼‰
interface ApiMessage {
  role: "user" | "assistant"
  content: string | ContentBlock[]
  ts: number

  // éç ´å£Šçš„ãªã‚¿ã‚°
  condenseParent?: string      // ã“ã®ã‚µãƒãƒªãƒ¼ã«ç½®ãæ›ãˆã‚‰ã‚ŒãŸ
  truncationParent?: string    // ã“ã®ãƒãƒ¼ã‚«ãƒ¼ã§éš ã•ã‚ŒãŸ
  isSummary?: boolean          // ã‚µãƒãƒªãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹
  isTruncationMarker?: boolean // ãƒˆãƒ©ãƒ³ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚«ãƒ¼ã‹
  condenseId?: string          // ã‚µãƒãƒªãƒ¼ã®ä¸€æ„ID
  truncationId?: string        // ãƒãƒ¼ã‚«ãƒ¼ã®ä¸€æ„ID
}

class ModernManager {
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å‰Šé™¤ã›ãšã‚¿ã‚°ä»˜ã‘
  hideMessages(messagesToHide: Message[], markerId: string) {
    return this.messages.map(msg => {
      if (messagesToHide.includes(msg)) {
        // ã‚¿ã‚°ä»˜ã‘ã™ã‚‹ã ã‘ï¼ˆå‰Šé™¤ã—ãªã„ï¼‰
        return {
          ...msg,
          truncationParent: markerId  // âœ… ã‚¿ã‚°ä»˜ã‘
        }
      }
      return msg
    })
  }

  // APIé€ä¿¡æ™‚ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  getEffectiveHistory(messages: ApiMessage[]): ApiMessage[] {
    // å­˜åœ¨ã™ã‚‹ãƒãƒ¼ã‚«ãƒ¼IDã‚’åé›†
    const existingMarkers = new Set(
      messages
        .filter(m => m.isTruncationMarker && m.truncationId)
        .map(m => m.truncationId)
    )

    // truncationParentã‚’æŒã¡ã€å¯¾å¿œã™ã‚‹ãƒãƒ¼ã‚«ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿é™¤å¤–
    return messages.filter(msg => {
      if (msg.truncationParent) {
        return !existingMarkers.has(msg.truncationParent)
      }
      return true  // ãã‚Œä»¥å¤–ã¯å«ã‚ã‚‹
    })
  }

  // å¾©å…ƒï¼ˆãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤ã§ã‚¿ã‚°ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
  restoreMessages(markerId: string) {
    // ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
    const withoutMarker = this.messages.filter(
      msg => !(msg.isTruncationMarker && msg.truncationId === markerId)
    )

    // å­¤ç«‹ã—ãŸã‚¿ã‚°ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    return withoutMarker.map(msg => {
      if (msg.truncationParent === markerId) {
        const { truncationParent, ...rest } = msg
        return rest  // âœ… ã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¦å¾©å…ƒ
      }
      return msg
    })
  }
}
```

#### å…·ä½“ä¾‹: ãƒãƒ¼ã‚«ãƒ¼ã«ã‚ˆã‚‹éš è”½

```typescript
// åˆæœŸçŠ¶æ…‹
const messages = [
  { id: 1, role: "user", content: "Hello" },
  { id: 2, role: "assistant", content: "Hi!" },
  { id: 3, role: "user", content: "How are you?" },
  { id: 4, role: "assistant", content: "I'm good!" },
  { id: 5, role: "user", content: "Great!" }
]

// ãƒˆãƒ©ãƒ³ã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼ˆ50%å‰Šé™¤ï¼‰
const truncationId = "uuid-abc-123"
const tagged = [
  { id: 1, role: "user", content: "Hello" },  // æœ€åˆã¯ä¿æŒ
  { id: 2, role: "assistant", content: "Hi!", truncationParent: "uuid-abc-123" },  // ã‚¿ã‚°
  { id: 3, role: "user", content: "How are you?", truncationParent: "uuid-abc-123" },  // ã‚¿ã‚°
  {
    role: "user",
    content: "[Truncation: 2 messages hidden]",
    isTruncationMarker: true,
    truncationId: "uuid-abc-123",
    ts: messages[3].ts - 1  // ä¿æŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç›´å‰
  },  // ãƒãƒ¼ã‚«ãƒ¼æŒ¿å…¥
  { id: 4, role: "assistant", content: "I'm good!" },
  { id: 5, role: "user", content: "Great!" }
]

// APIé€ä¿¡æ™‚
const effective = getEffectiveHistory(tagged)
// => [
//   { id: 1, ... },
//   { role: "user", content: "[Truncation: 2 messages hidden]", ... },
//   { id: 4, ... },
//   { id: 5, ... }
// ]

// å¾©å…ƒï¼ˆãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤ï¼‰
const restored = restoreMessages("uuid-abc-123")
// => å…ƒã®5ä»¶ã™ã¹ã¦ãŒå¾©å…ƒã•ã‚Œã‚‹ âœ…
```

#### åˆ©ç‚¹

âœ… **ãƒ‡ãƒ¼ã‚¿æå¤±ãªã—**: ã™ã¹ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä¿æŒã•ã‚Œã‚‹
âœ… **å¾©å…ƒå¯èƒ½**: ã„ã¤ã§ã‚‚éå»ã®çŠ¶æ…‹ã«æˆ»ã›ã‚‹
âœ… **ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆçµ±åˆ**: Shadow Gitã¨å®Œå…¨ã«çµ±åˆå¯èƒ½
âœ… **ãƒ‡ãƒãƒƒã‚°å®¹æ˜“**: å…¨å±¥æ­´ã‚’ç¢ºèªã§ãã‚‹
âœ… **ç›£æŸ»è¨¼è·¡**: ã™ã¹ã¦ã®æ“ä½œã‚’è¿½è·¡å¯èƒ½

---

### é€²åŒ–2: å˜ç´”å‰Šé™¤ â†’ çŸ¥çš„åœ§ç¸®ï¼ˆCondensationï¼‰

#### Before: æ©Ÿæ¢°çš„å‰Šé™¤

```typescript
// å¤ã„æ–¹æ³•
class OldCompressor {
  compress(messages: Message[], limit: number) {
    const tokenCount = this.countTokens(messages)

    if (tokenCount > limit) {
      // å…ˆé ­ã‹ã‚‰å‰Šé™¤
      const toRemove = Math.floor(messages.length * 0.3)  // 30%å‰Šé™¤
      return messages.slice(toRemove)  // âŒ æ©Ÿæ¢°çš„ã«å‰Šé™¤
    }

    return messages
  }
}

// å•é¡Œ:
// - é‡è¦ãªæƒ…å ±ã‚‚å®¹èµ¦ãªãå‰Šé™¤
// - æ–‡è„ˆãŒåˆ†æ–­ã•ã‚Œã‚‹
// - æƒ…å ±ãŒå®Œå…¨ã«å¤±ã‚ã‚Œã‚‹
```

#### After: AIè¦ç´„ + ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

```typescript
// æ–°ã—ã„æ–¹æ³•ï¼ˆäºŒæ®µéšã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼‰
class ModernCompressor {
  async manageContext(
    messages: ApiMessage[],
    tokenCount: number,
    contextWindow: number
  ): Promise<ContextResult> {
    const threshold = contextWindow * 0.75  // 75%

    if (tokenCount < threshold) {
      return { messages }  // ä½•ã‚‚ã—ãªã„
    }

    // ç¬¬1æ®µéš: Condensationï¼ˆAIè¦ç´„ï¼‰
    if (this.config.autoCondenseContext) {
      try {
        const result = await this.condense(messages)

        // æˆåŠŸãƒã‚§ãƒƒã‚¯
        if (result.newTokens < tokenCount) {
          return {
            messages: result.messages,
            summary: result.summary,
            condenseId: result.condenseId,
            reduction: tokenCount - result.newTokens
          }
        }
      } catch (error) {
        console.warn("Condensation failed, falling back to truncation")
        // ãƒ•ã‚©ãƒ¼ãƒ«ã‚¹ãƒ«ãƒ¼
      }
    }

    // ç¬¬2æ®µéš: Truncationï¼ˆã‚¹ãƒ©ã‚¤ãƒ‡ã‚£ãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼‰
    return this.truncate(messages, 0.5)  // 50%å‰Šé™¤
  }

  private async condense(
    messages: ApiMessage[]
  ): Promise<CondenseResult> {
    // ä¿æŒã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆæœ€æ–°3ä»¶ï¼‰
    const keepMessages = messages.slice(-3)

    // è¦ç´„å¯¾è±¡
    const toSummarize = messages.slice(0, -3)

    if (toSummarize.length === 0) {
      throw new Error("Not enough messages to summarize")
    }

    // LLMã§è¦ç´„ç”Ÿæˆ
    const summary = await this.llm.generate(`
ä»¥ä¸‹ã®ä¼šè©±ã‚’è¦ç´„ã—ã¦ãã ã•ã„ã€‚

é‡è¦ãªæƒ…å ±:
1. Previous Conversation: ä¼šè©±ã®æµã‚Œ
2. Current Work: ç¾åœ¨ä½œæ¥­ã—ã¦ã„ãŸã“ã¨
3. Key Technical Concepts: æŠ€è¡“çš„ãªæ¦‚å¿µ
4. Relevant Files and Code: é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«
5. Problem Solving: è§£æ±ºã—ãŸå•é¡Œ
6. Pending Tasks: æœªå®Œäº†ã®ã‚¿ã‚¹ã‚¯

ä¼šè©±å±¥æ­´:
${toSummarize.map(m => \`\${m.role}: \${m.content}\`).join('\\n')}

500èªä»¥å†…ã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚
`)

    // ã‚µãƒãƒªãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
    const condenseId = crypto.randomUUID()
    const summaryMessage: ApiMessage = {
      role: "assistant",
      content: [
        {
          type: "reasoning",
          text: "Condensing conversation context. The summary captures key information."
        },
        {
          type: "text",
          text: summary
        }
      ],
      ts: keepMessages[0].ts - 1,  // ä¿æŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç›´å‰
      isSummary: true,
      condenseId
    }

    // ä¸­é–“ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚¿ã‚°ä»˜ã‘
    const tagged = messages.map((msg, i) => {
      if (i === 0) return msg  // æœ€åˆã¯ä¿æŒ
      if (i >= messages.length - 3) return msg  // æœ€å¾Œ3ä»¶ã¯ä¿æŒ

      // ä¸­é–“ã¯ã‚¿ã‚°ä»˜ã‘
      return {
        ...msg,
        condenseParent: condenseId
      }
    })

    // ã‚µãƒãƒªãƒ¼æŒ¿å…¥
    const result = [
      tagged[0],  // æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      ...tagged.slice(1, -3),  // ã‚¿ã‚°ä»˜ãã®ä¸­é–“ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      summaryMessage,  // ã‚µãƒãƒªãƒ¼
      ...keepMessages  // æœ€æ–°3ä»¶
    ]

    // ãƒˆãƒ¼ã‚¯ãƒ³æ•°è¨ˆç®—
    const newTokens = await this.countTokens(result)

    return {
      messages: result,
      summary,
      condenseId,
      newTokens
    }
  }
}
```

#### å…·ä½“ä¾‹: Condensation ã®å‹•ä½œ

```typescript
// åˆæœŸçŠ¶æ…‹ï¼ˆ12ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
const messages = [
  { id: 0, role: "user", content: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–ã—ã¦" },
  { id: 1, role: "assistant", content: "npm initå®Ÿè¡Œã—ã¾ã—ãŸ" },
  { id: 2, role: "user", content: "Reactã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«" },
  { id: 3, role: "assistant", content: "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†" },
  { id: 4, role: "user", content: "App.tsxã‚’ä½œæˆ" },
  { id: 5, role: "assistant", content: "ä½œæˆã—ã¾ã—ãŸ" },
  { id: 6, role: "user", content: "ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¿½åŠ " },
  { id: 7, role: "assistant", content: "Button.tsxã‚’ä½œæˆ" },
  { id: 8, role: "user", content: "ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´" },
  { id: 9, role: "assistant", content: "CSSã‚’æ›´æ–°" },
  { id: 10, role: "user", content: "ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ" },  // æœ€æ–°3ä»¶
  { id: 11, role: "assistant", content: "æˆåŠŸã—ã¾ã—ãŸ" }  // æœ€æ–°3ä»¶
]

// Condensationå®Ÿè¡Œå¾Œ
const condensed = [
  { id: 0, role: "user", content: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–ã—ã¦" },  // æœ€åˆã¯ä¿æŒ

  // ä¸­é–“ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚¿ã‚°ä»˜ãï¼‰
  { id: 1, role: "assistant", content: "...", condenseParent: "uuid-123" },
  { id: 2, role: "user", content: "...", condenseParent: "uuid-123" },
  // ... id: 3-8 ã™ã¹ã¦ condenseParent: "uuid-123"
  { id: 9, role: "assistant", content: "...", condenseParent: "uuid-123" },

  // ã‚µãƒãƒªãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  {
    role: "assistant",
    content: [
      { type: "reasoning", text: "Condensing conversation context..." },
      {
        type: "text",
        text: `
Previous Conversation: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒReactãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ä¾é ¼
Current Work: UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆButton.tsxï¼‰ã®ä½œæˆã¨ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã‚’å®Œäº†
Key Technical Concepts: React, TypeScript, CSS
Relevant Files:
  - package.json: ä¾å­˜é–¢ä¿‚
  - App.tsx: ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
  - Button.tsx: ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
Problem Solving: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–ã‹ã‚‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆã¾ã§é †èª¿ã«å®Œäº†
Pending Tasks: ãªã—ï¼ˆãƒ“ãƒ«ãƒ‰å®Ÿè¡Œäºˆå®šï¼‰
`
      }
    ],
    isSummary: true,
    condenseId: "uuid-123"
  },

  // æœ€æ–°3ä»¶ï¼ˆä¿æŒï¼‰
  { id: 10, role: "user", content: "ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ" },
  { id: 11, role: "assistant", content: "æˆåŠŸã—ã¾ã—ãŸ" },
  { id: 12, role: "user", content: "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã—ã¦" }  // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
]

// APIé€ä¿¡æ™‚ï¼ˆãƒ•ã‚£ãƒ«ã‚¿å¾Œï¼‰
const effective = getEffectiveHistory(condensed)
// => [
//   { id: 0, ... },
//   { role: "assistant", content: [...], isSummary: true },  // ã‚µãƒãƒªãƒ¼
//   { id: 10, ... },
//   { id: 11, ... },
//   { id: 12, ... }
// ]

// ãƒˆãƒ¼ã‚¯ãƒ³å‰Šæ¸›
// Before: 12ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â‰ˆ 3000ãƒˆãƒ¼ã‚¯ãƒ³
// After:  5ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â‰ˆ 1000ãƒˆãƒ¼ã‚¯ãƒ³
// å‰Šæ¸›ç‡: 67% âœ…
```

#### åˆ©ç‚¹

âœ… **å¤§å¹…ãªãƒˆãƒ¼ã‚¯ãƒ³å‰Šæ¸›**: 70-90%ã®å‰Šæ¸›ãŒå¯èƒ½
âœ… **æƒ…å ±ä¿æŒ**: é‡è¦ãªæƒ…å ±ã¯ã‚µãƒãƒªãƒ¼ã«å«ã¾ã‚Œã‚‹
âœ… **æ–‡è„ˆã®é€£ç¶šæ€§**: ä¼šè©±ã®æµã‚ŒãŒç¶­æŒã•ã‚Œã‚‹
âœ… **å¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: Truncationã§ç¢ºå®Ÿã«å‰Šæ¸›
âœ… **å¾©å…ƒå¯èƒ½**: ã‚µãƒãƒªãƒ¼ã‚’å‰Šé™¤ã™ã‚Œã°å…ƒã«æˆ»ã‚‹

---

### é€²åŒ–3: ãƒ•ãƒ©ãƒƒãƒˆãªå±¥æ­´ â†’ éšå±¤çš„Stateç®¡ç†

#### Before: ãƒ•ãƒ©ãƒƒãƒˆãªé…åˆ—

```typescript
// å¤ã„æ–¹æ³•
interface OldState {
  messages: Message[]  // ã™ã¹ã¦åŒã˜ãƒ¬ãƒ™ãƒ«
  currentTool: Tool | null
  userInput: string
}

// å•é¡Œ:
// - ã™ã¹ã¦ãŒåŒã˜å„ªå…ˆåº¦
// - å¤ã„æƒ…å ±ã¨æ–°ã—ã„æƒ…å ±ã®åŒºåˆ¥ãªã—
// - åœ§ç¸®æˆ¦ç•¥ãŒé™å®šçš„
```

#### After: éšå±¤çš„æ§‹é€ ï¼ˆContext Engineeringï¼‰

```typescript
// æ–°ã—ã„æ–¹æ³•ï¼ˆAnthropicæ–¹å¼ï¼‰
interface LayeredState {
  // L0: System / Policyï¼ˆæœ€é«˜å„ªå…ˆåº¦ã€ä¸å¤‰ï¼‰
  system: {
    role: string                    // ã‚·ã‚¹ãƒ†ãƒ ãƒ­ãƒ¼ãƒ«
    policies: Policy[]              // å®‰å…¨ãƒãƒªã‚·ãƒ¼
    constraints: Constraint[]       // åˆ¶ç´„
    auditRequirements: AuditConfig  // ç›£æŸ»è¦ä»¶
  }

  // L1: Task contractï¼ˆã‚¿ã‚¹ã‚¯å®šç¾©ï¼‰
  task: {
    goal: string                    // æœ€çµ‚ç›®æ¨™
    successCriteria: Criterion[]    // æˆåŠŸæ¡ä»¶
    outputFormat: Schema            // å‡ºåŠ›å½¢å¼
    deadline?: Date                 // æœŸé™
  }

  // L2: Runtime Stateï¼ˆå®Ÿè¡Œæ™‚çŠ¶æ…‹ï¼‰
  runtime: {
    phase: "planning" | "executing" | "reflecting" | "verifying"
    permissions: Permission[]       // ç¾åœ¨ã®æ¨©é™
    environment: "dev" | "staging" | "prod"
    failureHistory: Failure[]       // å¤±æ•—å±¥æ­´
  }

  // L3: Memoryï¼ˆè¨˜æ†¶ã€è¤‡æ•°ç¨®é¡ï¼‰
  memory: {
    // çŸ­æœŸãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ¡ãƒ¢ãƒª
    shortTerm: {
      workingVariables: Record<string, any>  // ä½œæ¥­å¤‰æ•°
      recentTurns: Message[]                 // ç›´è¿‘3-5ã‚¿ãƒ¼ãƒ³
    }

    // ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰è¨˜æ†¶ï¼ˆå‡ºæ¥äº‹ï¼‰
    episodic: {
      summaries: Summary[]      // è¦ç´„
      decisions: Decision[]     // æ„æ€æ±ºå®š
      milestones: Milestone[]   // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³
    }

    // æ„å‘³è¨˜æ†¶ï¼ˆäº‹å®Ÿï¼‰
    semantic: {
      facts: Fact[]             // ç¢ºå®šäº‹å®Ÿ
      definitions: Definition[] // å®šç¾©
      preferences: Preference[] // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
      projectKnowledge: Knowledge[]  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçŸ¥è­˜
    }

    // æ‰‹ç¶šãè¨˜æ†¶ï¼ˆã‚„ã‚Šæ–¹ï¼‰
    procedural: {
      skills: Skill[]           // ã‚¹ã‚­ãƒ«
      templates: Template[]     // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
      checklists: Checklist[]   // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
      procedures: Procedure[]   // æ‰‹é †
    }
  }

  // L4: Evidenceï¼ˆè¦³æ¸¬ãƒ»æ¤œç´¢çµæœï¼‰
  evidence: {
    observations: Observation[]  // ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œçµæœ
    ragResults: RAGResult[]      // RAGæ¤œç´¢çµæœ
    citations: Citation[]        // å¼•ç”¨
    measurements: Measurement[]  // æ¸¬å®šå€¤
  }

  // L5: Work Bufferï¼ˆä½œæ¥­é ˜åŸŸã€æœ€ã‚‚å¤‰å‹•çš„ï¼‰
  workBuffer: {
    plan: Step[]                // è¨ˆç”»
    diff: Change[]              // å·®åˆ†
    hypotheses: Hypothesis[]    // ä»®èª¬
    draft: string              // ä¸‹æ›¸ã
  }
}
```

#### Context Builder: éšå±¤ã‚’çµ„ã¿ç«‹ã¦ã‚‹

```typescript
class ContextBuilder {
  async build(state: LayeredState): Promise<Context> {
    // å„å±¤ã‚’æ§‹é€ åŒ–ã•ã‚ŒãŸXMLã§æ§‹ç¯‰
    return `
<context>
  <!-- L0: Systemï¼ˆå¸¸ã«æœ€å„ªå…ˆï¼‰ -->
  <system>
    <role>${state.system.role}</role>
    <policies>
      ${state.system.policies.map(p => `<policy>${p}</policy>`).join('\n')}
    </policies>
  </system>

  <!-- L1: Task -->
  <task>
    <goal>${state.task.goal}</goal>
    <success_criteria>
      ${state.task.successCriteria.map(c => `<criterion>${c}</criterion>`).join('\n')}
    </success_criteria>
  </task>

  <!-- L2: Runtime State -->
  <runtime_state>
    <phase>${state.runtime.phase}</phase>
    <environment>${state.runtime.environment}</environment>
    <permissions>
      ${state.runtime.permissions.map(p => `<permission>${p}</permission>`).join('\n')}
    </permissions>
  </runtime_state>

  <!-- L3: Memoryï¼ˆåœ§ç¸®ãƒ»ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿ï¼‰ -->
  <memory>
    <!-- çŸ­æœŸãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ¡ãƒ¢ãƒªï¼ˆæœ€æ–°ï¼‰ -->
    <short_term>
      <recent_turns>
        ${state.memory.shortTerm.recentTurns.map(t =>
          `<turn role="${t.role}">${t.content}</turn>`
        ).join('\n')}
      </recent_turns>
    </short_term>

    <!-- ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰è¨˜æ†¶ï¼ˆè¦ç´„æ¸ˆã¿ï¼‰ -->
    <episodic>
      ${state.memory.episodic.summaries
        .filter(s => this.isRelevant(s, state.task))
        .map(s => `<summary>${s.text}</summary>`)
        .join('\n')}
    </episodic>

    <!-- æ„å‘³è¨˜æ†¶ï¼ˆé–¢é€£ã™ã‚‹äº‹å®Ÿã®ã¿ï¼‰ -->
    <semantic>
      ${state.memory.semantic.facts
        .filter(f => this.isRelevant(f, state.task))
        .map(f => `<fact source="${f.source}">${f.content}</fact>`)
        .join('\n')}
    </semantic>
  </memory>

  <!-- L4: Evidenceï¼ˆæ–°ã—ã„è¦³æ¸¬ã‚’å„ªå…ˆï¼‰ -->
  <evidence>
    <recent_observations>
      ${state.evidence.observations
        .filter(o => Date.now() - o.timestamp < 60000)  // 1åˆ†ä»¥å†…
        .map(o => `
          <observation tool="${o.tool}" timestamp="${o.timestamp}">
            ${o.result}
          </observation>
        `).join('\n')}
    </recent_observations>

    <rag_results>
      ${state.evidence.ragResults.map(r => `
        <result relevance="${r.relevance}">
          <source>${r.source}</source>
          <content>${r.content}</content>
        </result>
      `).join('\n')}
    </rag_results>
  </evidence>

  <!-- L5: Work Bufferï¼ˆç¾åœ¨ã®ä½œæ¥­ï¼‰ -->
  <work_buffer>
    <plan>
      ${state.workBuffer.plan.map((step, i) => `
        <step id="${i}" status="${step.status}">
          ${step.description}
        </step>
      `).join('\n')}
    </plan>
  </work_buffer>
</context>
`
  }

  private isRelevant(item: any, task: Task): boolean {
    // ãƒ™ã‚¯ãƒˆãƒ«é¡ä¼¼åº¦ã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒã§é–¢é€£æ€§åˆ¤å®š
    const similarity = this.cosineSimilarity(
      this.embed(item.content),
      this.embed(task.goal)
    )

    return similarity > 0.3  // é–¾å€¤
  }
}
```

#### ãƒˆãƒ¼ã‚¯ãƒ³äºˆç®—é…åˆ†

```typescript
class TokenBudgetAllocator {
  allocate(state: LayeredState, maxTokens: number): BudgetAllocation {
    const budget = maxTokens * 0.9  // 10%ãƒãƒƒãƒ•ã‚¡

    // éšå±¤åˆ¥ã®äºˆç®—é…åˆ†
    return {
      system: {
        budget: budget * 0.05,      // 5% - é‡è¦ã ãŒçŸ­ã„
        priority: Priority.CRITICAL
      },

      task: {
        budget: budget * 0.05,      // 5%
        priority: Priority.CRITICAL
      },

      runtime: {
        budget: budget * 0.03,      // 3%
        priority: Priority.HIGH
      },

      memory: {
        shortTerm: {
          budget: budget * 0.20,    // 20% - ç›´è¿‘ã®æ–‡è„ˆ
          priority: Priority.HIGH
        },
        episodic: {
          budget: budget * 0.15,    // 15% - è¦ç´„æ¸ˆã¿
          priority: Priority.MEDIUM
        },
        semantic: {
          budget: budget * 0.10,    // 10% - é–¢é€£ã™ã‚‹äº‹å®Ÿ
          priority: Priority.MEDIUM
        },
        procedural: {
          budget: budget * 0.07,    // 7% - å¿…è¦ãªã‚¹ã‚­ãƒ«
          priority: Priority.MEDIUM
        }
      },

      evidence: {
        observations: {
          budget: budget * 0.25,    // 25% - æœ€æ–°ã®è¦³æ¸¬
          priority: Priority.HIGH
        },
        ragResults: {
          budget: budget * 0.10,    // 10%
          priority: Priority.MEDIUM
        }
      },

      workBuffer: {
        budget: budget * 0.10,      // 10%
        priority: Priority.MEDIUM
      }
    }
  }

  async fitToBudget(
    content: any,
    budgetTokens: number
  ): Promise<any> {
    const currentTokens = await this.countTokens(content)

    if (currentTokens <= budgetTokens) {
      return content  // äºˆç®—å†…
    }

    // äºˆç®—è¶…é â†’ åœ§ç¸®
    if (Array.isArray(content)) {
      // é…åˆ—ã®å ´åˆ: å„ªå…ˆåº¦ã§ã‚½ãƒ¼ãƒˆâ†’ä¸Šä½ã‚’ä¿æŒ
      const withPriority = content.map(item => ({
        item,
        priority: this.calculatePriority(item)
      }))

      withPriority.sort((a, b) => b.priority - a.priority)

      // äºˆç®—å†…ã«åã¾ã‚‹ã¾ã§ä¿æŒ
      let accumulated = 0
      const result = []

      for (const { item } of withPriority) {
        const tokens = await this.countTokens(item)

        if (accumulated + tokens <= budgetTokens) {
          result.push(item)
          accumulated += tokens
        } else {
          break
        }
      }

      return result
    } else if (typeof content === 'string') {
      // æ–‡å­—åˆ—ã®å ´åˆ: è¦ç´„
      return await this.summarize(content, budgetTokens)
    }

    return content
  }
}
```

#### åˆ©ç‚¹

âœ… **æ˜ç¢ºãªå„ªå…ˆåº¦**: ã©ã®æƒ…å ±ãŒé‡è¦ã‹ãŒæ˜ç¢º
âœ… **æŸ”è»Ÿãªåœ§ç¸®**: å±¤ã”ã¨ã«æœ€é©ãªæˆ¦ç•¥ã‚’é©ç”¨
âœ… **åŠ¹ç‡çš„ãªãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨**: äºˆç®—é…åˆ†ã«ã‚ˆã‚Šæœ€é©åŒ–
âœ… **æ‹¡å¼µæ€§**: æ–°ã—ã„å±¤ã‚’è¿½åŠ ã—ã‚„ã™ã„
âœ… **é–¢é€£æ€§ãƒ•ã‚£ãƒ«ã‚¿**: ã‚¿ã‚¹ã‚¯ã«é–¢é€£ã™ã‚‹æƒ…å ±ã®ã¿ä¿æŒ

---

### é€²åŒ–4: é™çš„ãƒ„ãƒ¼ãƒ« â†’ å‹•çš„ãƒ„ãƒ¼ãƒ«æŠ•å½±

#### Before: ã™ã¹ã¦ã®ãƒ„ãƒ¼ãƒ«ã‚’å¸¸ã«æä¾›

```typescript
// å¤ã„æ–¹æ³•
class OldToolManager {
  getTools(): Tool[] {
    // å¸¸ã«å…¨ãƒ„ãƒ¼ãƒ«ã‚’è¿”ã™
    return [
      readFileTool,
      writeFileTool,
      deleteFileTool,      // âŒ å¸¸ã«è¦‹ãˆã‚‹
      executeTool,         // âŒ å¸¸ã«è¦‹ãˆã‚‹
      searchTool,
      analyzeTool,
      deployTool,          // âŒ å¸¸ã«è¦‹ãˆã‚‹ï¼ˆå±é™ºï¼‰
      rollbackTool         // âŒ å¸¸ã«è¦‹ãˆã‚‹ï¼ˆå±é™ºï¼‰
    ]
  }
}

// å•é¡Œ:
// 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯
// 2. ãƒˆãƒ¼ã‚¯ãƒ³ã®ç„¡é§„
// 3. LLMã®æ··ä¹±ï¼ˆé¸æŠè‚¢ãŒå¤šã™ãã‚‹ï¼‰
// 4. èª¤æ“ä½œã®ãƒªã‚¹ã‚¯
```

#### After: çŠ¶æ…‹ã«å¿œã˜ãŸå‹•çš„æŠ•å½±

```typescript
// æ–°ã—ã„æ–¹æ³•
class DynamicToolProjector {
  project(
    state: LayeredState,
    allTools: Tool[]
  ): Tool[] {
    let tools = [...allTools]

    // ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ•ã‚§ãƒ¼ã‚ºãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    tools = this.filterByPhase(tools, state.runtime.phase)

    // ã‚¹ãƒ†ãƒƒãƒ—2: æ¨©é™ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    tools = this.filterByPermission(tools, state.runtime.permissions)

    // ã‚¹ãƒ†ãƒƒãƒ—3: ç’°å¢ƒã«å¿œã˜ãŸã‚¹ã‚­ãƒ¼ãƒåˆ¶é™
    tools = this.restrictSchema(tools, state.runtime.environment)

    // ã‚¹ãƒ†ãƒƒãƒ—4: Tool budgetï¼ˆãƒˆãƒ¼ã‚¯ãƒ³åŠ¹ç‡åŒ–ï¼‰
    tools = this.applyToolBudget(tools, state)

    return tools
  }

  // ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  private filterByPhase(
    tools: Tool[],
    phase: RuntimeState['phase']
  ): Tool[] {
    const phaseToolMap: Record<string, string[]> = {
      planning: [
        'search',      // æƒ…å ±åé›†
        'analyze',     // åˆ†æ
        'estimate',    // è¦‹ç©ã‚‚ã‚Š
        'readFile'     // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
      ],

      executing: [
        'writeFile',   // ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿
        'execute',     // å®Ÿè¡Œ
        'modify',      // ä¿®æ­£
        'test'         // ãƒ†ã‚¹ãƒˆ
      ],

      reflecting: [
        'evaluate',    // è©•ä¾¡
        'test',        // ãƒ†ã‚¹ãƒˆ
        'compare',     // æ¯”è¼ƒ
        'measure'      // æ¸¬å®š
      ],

      verifying: [
        'verify',      // æ¤œè¨¼
        'audit',       // ç›£æŸ»
        'approve'      // æ‰¿èª
      ]
    }

    const allowedCategories = phaseToolMap[phase] || []

    return tools.filter(tool =>
      allowedCategories.includes(tool.category)
    )
  }

  // æ¨©é™åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  private filterByPermission(
    tools: Tool[],
    permissions: Permission[]
  ): Tool[] {
    return tools.filter(tool => {
      // ãƒ„ãƒ¼ãƒ«ã«å¿…è¦ãªæ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯
      const requiredPermissions = tool.requiredPermissions || []

      return requiredPermissions.every(required =>
        permissions.some(p => p.includes(required))
      )
    })
  }

  // ç’°å¢ƒã«å¿œã˜ãŸã‚¹ã‚­ãƒ¼ãƒåˆ¶é™
  private restrictSchema(
    tools: Tool[],
    environment: RuntimeState['environment']
  ): Tool[] {
    if (environment === 'production') {
      return tools.map(tool => this.addProductionSafety(tool))
    }

    return tools
  }

  private addProductionSafety(tool: Tool): Tool {
    // ä¾‹: deleteFileãƒ„ãƒ¼ãƒ«
    if (tool.name === 'deleteFile') {
      return {
        ...tool,
        parameters: {
          ...tool.parameters,
          properties: {
            ...tool.parameters.properties,
            path: {
              type: 'string',
              // æœ¬ç•ªç’°å¢ƒã§ã¯è¨±å¯ã•ã‚ŒãŸãƒ‘ã‚¹ã®ã¿
              enum: [
                '/tmp/allowed-file-1.txt',
                '/tmp/allowed-file-2.txt'
              ],
              description: 'File path (production: whitelist only)'
            }
          }
        }
      }
    }

    // ä¾‹: executeãƒ„ãƒ¼ãƒ«
    if (tool.name === 'execute') {
      return {
        ...tool,
        parameters: {
          ...tool.parameters,
          properties: {
            ...tool.parameters.properties,
            command: {
              type: 'string',
              // æœ¬ç•ªç’°å¢ƒã§ã¯å®‰å…¨ãªã‚³ãƒãƒ³ãƒ‰ã®ã¿
              enum: [
                'npm test',
                'npm run build',
                'npm run lint'
              ],
              description: 'Command (production: safe commands only)'
            }
          }
        }
      }
    }

    return tool
  }

  // Tool budgeté©ç”¨
  private applyToolBudget(
    tools: Tool[],
    state: LayeredState
  ): Tool[] {
    // ã‚¿ã‚¹ã‚¯ã®ç·Šæ€¥åº¦ãƒ»é‡è¦åº¦ã«å¿œã˜ã¦ãƒ„ãƒ¼ãƒ«æ•°ã‚’åˆ¶é™
    const urgency = this.calculateUrgency(state.task)

    if (urgency === 'high') {
      // ç·Šæ€¥æ™‚ã¯é‡è¦ãªãƒ„ãƒ¼ãƒ«ã®ã¿
      return tools
        .sort((a, b) => b.priority - a.priority)
        .slice(0, 5)  // ä¸Šä½5ä»¶
    }

    // é€šå¸¸æ™‚ã¯ãƒˆãƒ¼ã‚¯ãƒ³äºˆç®—å†…ã«åã‚ã‚‹
    const budgetTokens = 2000  // ãƒ„ãƒ¼ãƒ«å®šç¾©ç”¨ã®ãƒˆãƒ¼ã‚¯ãƒ³äºˆç®—
    let accumulated = 0
    const result: Tool[] = []

    for (const tool of tools) {
      const toolTokens = this.estimateToolTokens(tool)

      if (accumulated + toolTokens <= budgetTokens) {
        result.push(tool)
        accumulated += toolTokens
      } else {
        break
      }
    }

    return result
  }
}
```

#### å…·ä½“ä¾‹: ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã®ãƒ„ãƒ¼ãƒ«å¤‰åŒ–

```typescript
const allTools = [
  { name: 'search', category: 'search', priority: 80 },
  { name: 'readFile', category: 'readFile', priority: 90 },
  { name: 'writeFile', category: 'writeFile', priority: 85 },
  { name: 'deleteFile', category: 'deleteFile', priority: 50, requiredPermissions: ['admin'] },
  { name: 'execute', category: 'execute', priority: 70 },
  { name: 'test', category: 'test', priority: 75 },
  { name: 'deploy', category: 'deploy', priority: 60, requiredPermissions: ['deploy'] }
]

// Planning ãƒ•ã‚§ãƒ¼ã‚º
const state1 = {
  runtime: {
    phase: 'planning',
    permissions: ['read', 'search'],
    environment: 'dev'
  }
}

const tools1 = projector.project(state1, allTools)
// => [search, readFile]
// âœ… æƒ…å ±åé›†ç³»ã®ã¿
// âœ… write/delete/execute ã¯è¦‹ãˆãªã„

// Executing ãƒ•ã‚§ãƒ¼ã‚º
const state2 = {
  runtime: {
    phase: 'executing',
    permissions: ['read', 'write', 'execute'],
    environment: 'dev'
  }
}

const tools2 = projector.project(state2, allTools)
// => [readFile, writeFile, execute, test]
// âœ… å®Ÿè¡Œç³»ãŒè¦‹ãˆã‚‹
// âœ… deploy ã¯æ¨©é™ä¸è¶³ã§è¦‹ãˆãªã„

// Executing ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
const state3 = {
  runtime: {
    phase: 'executing',
    permissions: ['read', 'write', 'execute', 'admin'],
    environment: 'production'
  }
}

const tools3 = projector.project(state3, allTools)
// => [
//   readFile,
//   writeFile,
//   deleteFile (with enum restrictions),  // âœ… ãƒ‘ã‚¹åˆ¶é™
//   execute (with enum restrictions),     // âœ… ã‚³ãƒãƒ³ãƒ‰åˆ¶é™
//   test
// ]
```

#### åˆ©ç‚¹

âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**: ãƒ•ã‚§ãƒ¼ã‚ºãƒ»æ¨©é™ãƒ»ç’°å¢ƒã§åˆ¶é™
âœ… **ãƒˆãƒ¼ã‚¯ãƒ³åŠ¹ç‡**: å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã®ã¿æä¾›
âœ… **èª¤æ“ä½œé˜²æ­¢**: å±é™ºãªãƒ„ãƒ¼ãƒ«ã‚’éš ã™
âœ… **LLMã®ç²¾åº¦å‘ä¸Š**: é¸æŠè‚¢ãŒçµã‚‰ã‚Œã¦åˆ¤æ–­ã—ã‚„ã™ã„
âœ… **ç›£æŸ»è¨¼è·¡**: ã©ã®ãƒ„ãƒ¼ãƒ«ãŒã„ã¤ä½¿ãˆãŸã‹è¨˜éŒ²

---

### é€²åŒ–5: tool_useå˜ä½“ â†’ tool_use/tool_resultãƒšã‚¢ä¿æŒ

#### Before: ãƒšã‚¢ãŒå´©ã‚Œã‚‹

```typescript
// å¤ã„æ–¹æ³•: è¦ç´„æ™‚ã«tool_useãŒå¤±ã‚ã‚Œã‚‹
async summarize(messages: Message[]): Promise<Message[]> {
  const toSummarize = messages.slice(0, -3)
  const keep = messages.slice(-3)  // æœ€æ–°3ä»¶ä¿æŒ

  const summary = await this.llm.generate(...)

  return [
    { role: 'assistant', content: summary },  // ã‚µãƒãƒªãƒ¼
    ...keep  // æœ€æ–°3ä»¶
  ]
}

// å•é¡Œ: æœ€åˆã®keepãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒtool_resultã‚’å«ã‚€å ´åˆ
// Before:
// [
//   { role: 'assistant', content: [..., tool_use] },  // è¦ç´„å¯¾è±¡
//   { role: 'user', content: [..., tool_result] }     // ä¿æŒ
// ]

// After:
// [
//   { role: 'assistant', content: 'Summary...' },     // tool_use ãŒãªã„
//   { role: 'user', content: [..., tool_result] }     // âŒ ãƒšã‚¢ãŒå´©ã‚Œã‚‹
// ]

// ã‚¨ãƒ©ãƒ¼: "tool_result requires matching tool_use"
```

#### After: ãƒšã‚¢ä¿æŒï¼ˆNative Toolså¯¾å¿œï¼‰

```typescript
// æ–°ã—ã„æ–¹æ³•ï¼ˆRoo Codeæ–¹å¼ï¼‰
async summarize(
  messages: Message[],
  useNativeTools: boolean
): Promise<Message[]> {
  const keep = messages.slice(-3)
  const toSummarize = messages.slice(0, -3)

  // Native Toolsä½¿ç”¨æ™‚: tool_useãƒ–ãƒ­ãƒƒã‚¯æŠ½å‡º
  let toolUseBlocks: ToolUseBlock[] = []
  let reasoningBlocks: ReasoningBlock[] = []

  if (useNativeTools) {
    const result = this.extractToolBlocks(keep, messages)
    toolUseBlocks = result.toolUseBlocks
    reasoningBlocks = result.reasoningBlocks
  }

  // ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
  const summaryText = await this.llm.generate(...)

  // ã‚µãƒãƒªãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹ç¯‰
  const summaryContent: ContentBlock[] = [
    // åˆæˆreasoningï¼ˆDeepSeekå¯¾å¿œï¼‰
    {
      type: 'reasoning',
      text: 'Condensing conversation context. Summary captures key information.'
    },

    // å…ƒã®reasoningãƒ–ãƒ­ãƒƒã‚¯ä¿æŒ
    ...reasoningBlocks,

    // ã‚µãƒãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ
    {
      type: 'text',
      text: summaryText
    },

    // tool_useãƒ–ãƒ­ãƒƒã‚¯ä¿æŒï¼ˆé‡è¦ï¼ï¼‰
    ...toolUseBlocks
  ]

  return [
    {
      role: 'assistant',
      content: summaryContent,
      isSummary: true
    },
    ...keep
  ]
}

// tool_useãƒ–ãƒ­ãƒƒã‚¯æŠ½å‡º
private extractToolBlocks(
  keepMessages: Message[],
  allMessages: Message[]
): ExtractResult {
  // æœ€åˆã®keepãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
  const firstKeep = keepMessages[0]

  // tool_resultã‚’å«ã‚€ã‹ï¼Ÿ
  const hasToolResult = this.hasToolResultBlocks(firstKeep)

  if (!hasToolResult) {
    return { toolUseBlocks: [], reasoningBlocks: [] }
  }

  // ç›´å‰ã®assistantãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
  const keepStartIndex = allMessages.indexOf(firstKeep)
  const precedingIndex = keepStartIndex - 1

  if (precedingIndex < 0) {
    return { toolUseBlocks: [], reasoningBlocks: [] }
  }

  const precedingMessage = allMessages[precedingIndex]

  if (precedingMessage.role !== 'assistant') {
    return { toolUseBlocks: [], reasoningBlocks: [] }
  }

  // tool_useãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠ½å‡º
  const toolUseBlocks = this.getToolUseBlocks(precedingMessage)

  // reasoningãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠ½å‡ºï¼ˆDeepSeekå¯¾å¿œï¼‰
  const reasoningBlocks = this.getReasoningBlocks(precedingMessage)

  return { toolUseBlocks, reasoningBlocks }
}

private getToolUseBlocks(message: Message): ToolUseBlock[] {
  if (!Array.isArray(message.content)) {
    return []
  }

  return message.content.filter(
    block => block.type === 'tool_use'
  ) as ToolUseBlock[]
}

private getReasoningBlocks(message: Message): ReasoningBlock[] {
  if (!Array.isArray(message.content)) {
    return []
  }

  return message.content.filter(
    block => block.type === 'reasoning'
  ) as ReasoningBlock[]
}
```

#### å…·ä½“ä¾‹: ãƒšã‚¢ä¿æŒã®å‹•ä½œ

```typescript
// åˆæœŸçŠ¶æ…‹
const messages = [
  { id: 1, role: 'user', content: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã‚“ã§' },
  { id: 2, role: 'assistant', content: 'readFileãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã„ã¾ã™' },
  // ... å¤šæ•°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ...

  // ç›´å‰ã®assistantãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆtool_useå«ã‚€ï¼‰
  {
    id: 98,
    role: 'assistant',
    content: [
      { type: 'reasoning', text: 'Using readFile to check content' },
      {
        type: 'tool_use',
        id: 'tool_abc',
        name: 'readFile',
        input: { path: 'test.js' }
      }
    ]
  },

  // æœ€åˆã®keepãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆtool_resultå«ã‚€ï¼‰
  {
    id: 99,
    role: 'user',
    content: [
      {
        type: 'tool_result',
        tool_use_id: 'tool_abc',
        content: 'console.log("hello")'
      }
    ]
  },  // â† keepé–‹å§‹ä½ç½®

  { id: 100, role: 'assistant', content: 'ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’ç¢ºèªã—ã¾ã—ãŸ' },
  { id: 101, role: 'user', content: 'æ¬¡ã¯ä½•ã‚’ã™ã‚‹ï¼Ÿ' }
]

// è¦ç´„å®Ÿè¡Œï¼ˆuseNativeTools: trueï¼‰
const result = await summarize(messages, true)

// çµæœ
// [
//   {
//     role: 'assistant',
//     content: [
//       // åˆæˆreasoning
//       { type: 'reasoning', text: 'Condensing conversation context...' },
//
//       // å…ƒã®reasoningãƒ–ãƒ­ãƒƒã‚¯ï¼ˆä¿æŒï¼‰
//       { type: 'reasoning', text: 'Using readFile to check content' },
//
//       // ã‚µãƒãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ
//       { type: 'text', text: 'Previous conversation: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚’ä¾é ¼...' },
//
//       // tool_useãƒ–ãƒ­ãƒƒã‚¯ï¼ˆä¿æŒï¼ï¼‰
//       {
//         type: 'tool_use',
//         id: 'tool_abc',
//         name: 'readFile',
//         input: { path: 'test.js' }
//       }
//     ],
//     isSummary: true
//   },
//
//   // keepï¼ˆæœ€æ–°3ä»¶ï¼‰
//   {
//     id: 99,
//     role: 'user',
//     content: [
//       {
//         type: 'tool_result',
//         tool_use_id: 'tool_abc',  // âœ… å¯¾å¿œã™ã‚‹tool_useãŒã‚µãƒãƒªãƒ¼ã«å«ã¾ã‚Œã¦ã„ã‚‹
//         content: 'console.log("hello")'
//       }
//     ]
//   },
//   { id: 100, role: 'assistant', content: '...' },
//   { id: 101, role: 'user', content: '...' }
// ]

// âœ… tool_use/tool_resultãƒšã‚¢ãŒç¶­æŒã•ã‚Œã‚‹
// âœ… Native Toolsãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«æº–æ‹ 
// âœ… DeepSeekå¯¾å¿œï¼ˆreasoningãƒ–ãƒ­ãƒƒã‚¯å«ã‚€ï¼‰
```

#### åˆ©ç‚¹

âœ… **Native Toolsãƒ—ãƒ­ãƒˆã‚³ãƒ«æº–æ‹ **: tool_use/resultãƒšã‚¢ç¶­æŒ
âœ… **DeepSeek/Z.aiå¯¾å¿œ**: reasoning_contentã‚’ä¿æŒ
âœ… **APIäº’æ›æ€§**: ã‚¨ãƒ©ãƒ¼ãªãå‹•ä½œ
âœ… **æ–‡è„ˆä¿æŒ**: ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã®æ„å›³ãŒæ®‹ã‚‹

---

### é€²åŒ–6: ç›´æ¥å‰Šé™¤ â†’ MessageManagerçµ±åˆ

#### Before: ç›´æ¥æ“ä½œï¼ˆå±é™ºï¼‰

```typescript
// å¤ã„æ–¹æ³•: ç›´æ¥å‰Šé™¤
class OldMessageHandler {
  deleteMessage(messageId: string) {
    // clineMessagesã‹ã‚‰å‰Šé™¤
    this.clineMessages = this.clineMessages.filter(
      m => m.id !== messageId
    )  // âŒ ç›´æ¥å‰Šé™¤

    // apiConversationHistoryã‹ã‚‰å‰Šé™¤
    this.apiConversationHistory = this.apiConversationHistory.filter(
      m => m.id !== messageId
    )  // âŒ ç›´æ¥å‰Šé™¤

    // å•é¡Œ:
    // 1. ã‚µãƒãƒªãƒ¼ãŒå­¤ç«‹ã™ã‚‹
    // 2. ãƒãƒ¼ã‚«ãƒ¼ãŒå­¤ç«‹ã™ã‚‹
    // 3. ã‚¿ã‚°ãŒå­¤ç«‹ã™ã‚‹
    // 4. ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã¨ä¸æ•´åˆ
  }
}
```

#### After: MessageManagerçµ±åˆ

```typescript
// æ–°ã—ã„æ–¹æ³•ï¼ˆRoo Codeæ–¹å¼ï¼‰
class MessageManager {
  constructor(
    private state: LayeredState,
    private checkpointService: CheckpointService
  ) {}

  async rewindToTimestamp(
    ts: number,
    options: RewindOptions = {}
  ): Promise<void> {
v    const { includeTargetMessage = false } = options

    // ã‚¹ãƒ†ãƒƒãƒ—1: å‰Šé™¤ã•ã‚Œã‚‹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆIDã‚’åé›†
    const removedIds = this.collectRemovedContextEventIds(ts)

    // ã‚¹ãƒ†ãƒƒãƒ—2: clineMessagesã‚’å‰Šé™¤
    await this.truncateClineMessages(ts, includeTargetMessage)

    // ã‚¹ãƒ†ãƒƒãƒ—3: apiConversationHistoryã‚’å‰Šé™¤ + ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    await this.truncateApiHistory(ts, removedIds)

    // ã‚¹ãƒ†ãƒƒãƒ—4: ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆåŒæœŸ
    await this.syncCheckpoint(ts)
  }

  // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆIDåé›†
  private collectRemovedContextEventIds(
    cutoffTs: number
  ): ContextEventIds {
    const condenseIds = new Set<string>()
    const truncationIds = new Set<string>()

    // cutoffä»¥é™ã®clineMessagesã‚’èµ°æŸ»
    for (const msg of this.state.clineMessages) {
      if (msg.ts >= cutoffTs) {
        // condense_contextã‚¤ãƒ™ãƒ³ãƒˆ
        if (msg.say === 'condense_context' && msg.contextCondense?.condenseId) {
          condenseIds.add(msg.contextCondense.condenseId)
        }

        // sliding_window_truncationã‚¤ãƒ™ãƒ³ãƒˆ
        if (msg.say === 'sliding_window_truncation' && msg.contextTruncation?.truncationId) {
          truncationIds.add(msg.contextTruncation.truncationId)
        }
      }
    }

    return { condenseIds, truncationIds }
  }

  // apiConversationHistoryå‰Šé™¤ + ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  private async truncateApiHistory(
    cutoffTs: number,
    removedIds: ContextEventIds
  ): Promise<void> {
    let history = [...this.state.apiConversationHistory]

    // ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—èª¿æ•´ï¼‰
    const actualCutoff = this.adjustCutoffTimestamp(history, cutoffTs)

    // ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§ãƒ•ã‚£ãƒ«ã‚¿
    history = history.filter(m => !m.ts || m.ts < actualCutoff)

    // ã‚¹ãƒ†ãƒƒãƒ—3: å­¤ç«‹ã—ãŸã‚µãƒãƒªãƒ¼å‰Šé™¤
    if (removedIds.condenseIds.size > 0) {
      history = history.filter(msg => {
        if (msg.isSummary && msg.condenseId && removedIds.condenseIds.has(msg.condenseId)) {
          console.log(`[MessageManager] Removing orphaned summary: ${msg.condenseId}`)
          return false  // å‰Šé™¤
        }
        return true
      })
    }

    // ã‚¹ãƒ†ãƒƒãƒ—4: å­¤ç«‹ã—ãŸãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤
    if (removedIds.truncationIds.size > 0) {
      history = history.filter(msg => {
        if (msg.isTruncationMarker && msg.truncationId && removedIds.truncationIds.has(msg.truncationId)) {
          console.log(`[MessageManager] Removing orphaned marker: ${msg.truncationId}`)
          return false  // å‰Šé™¤
        }
        return true
      })
    }

    // ã‚¹ãƒ†ãƒƒãƒ—5: ã‚¿ã‚°ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    history = this.cleanupOrphanedTags(history)

    // ä¿å­˜
    this.state.apiConversationHistory = history
    await this.saveApiHistory(history)
  }

  // å­¤ç«‹ã—ãŸã‚¿ã‚°ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  private cleanupOrphanedTags(messages: Message[]): Message[] {
    // å­˜åœ¨ã™ã‚‹ã‚µãƒãƒªãƒ¼/ãƒãƒ¼ã‚«ãƒ¼IDã‚’åé›†
    const existingCondenseIds = new Set(
      messages
        .filter(m => m.isSummary && m.condenseId)
        .map(m => m.condenseId)
    )

    const existingTruncationIds = new Set(
      messages
        .filter(m => m.isTruncationMarker && m.truncationId)
        .map(m => m.truncationId)
    )

    // å­¤ç«‹ã—ãŸã‚¿ã‚°ã‚’å‰Šé™¤
    return messages.map(msg => {
      let needsUpdate = false

      // condenseParentãƒã‚§ãƒƒã‚¯
      if (msg.condenseParent && !existingCondenseIds.has(msg.condenseParent)) {
        needsUpdate = true
      }

      // truncationParentãƒã‚§ãƒƒã‚¯
      if (msg.truncationParent && !existingTruncationIds.has(msg.truncationParent)) {
        needsUpdate = true
      }

      if (!needsUpdate) {
        return msg
      }

      // ã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¦å¾©å…ƒ
      const { condenseParent, truncationParent, ...rest } = msg
      const result: Message = rest

      // å­˜åœ¨ã™ã‚‹å‚ç…§ã®ã¿ä¿æŒ
      if (condenseParent && existingCondenseIds.has(condenseParent)) {
        result.condenseParent = condenseParent
      }

      if (truncationParent && existingTruncationIds.has(truncationParent)) {
        result.truncationParent = truncationParent
      }

      return result
    })
  }

  // ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å¯¾ç­–
  private adjustCutoffTimestamp(
    history: Message[],
    cutoffTs: number
  ): number {
    // cutoffã«å®Œå…¨ä¸€è‡´ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚‹ã‹
    const hasExactMatch = history.some(m => m.ts === cutoffTs)

    // cutoffä»¥å‰ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚‹ã‹
    const hasMessageBefore = history.some(m => m.ts !== undefined && m.ts < cutoffTs)

    // ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³æ¤œå‡º
    if (!hasExactMatch && hasMessageBefore) {
      // æœ€åˆã®userãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆcutoffä»¥é™ï¼‰ã‚’å¢ƒç•Œã¨ã™ã‚‹
      const firstUserAfter = history.find(
        m => m.ts !== undefined && m.ts >= cutoffTs && m.role === 'user'
      )

      if (firstUserAfter && firstUserAfter.ts) {
        console.log(`[MessageManager] Adjusting cutoff: ${cutoffTs} â†’ ${firstUserAfter.ts}`)
        return firstUserAfter.ts
      }
    }

    return cutoffTs
  }

  // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆåŒæœŸ
  private async syncCheckpoint(ts: number): Promise<void> {
    if (!this.checkpointService) {
      return
    }

    // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚‚åŒã˜ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¾ã§å·»ãæˆ»ã—
    await this.checkpointService.rewindTo(ts)
  }
}
```

#### ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å•é¡Œ

```typescript
// ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å®Ÿè¡Œä¸­ã®å•é¡Œ

// Timeline:
// T1: Assistant message starts streaming
// T2: Tool execution completes â†’ user_feedback clineMessage created (ts=T2)
// T3: Assistant message stream completes â†’ API message saved (ts=T3)

// çµæœ:
// clineMessage(user_feedback, ts=T2) < apiMessage(assistant, ts=T3)

// å•é¡Œ:
// T2ã§å·»ãæˆ»ã™ã¨ã€clineMessageã®T2ã¯è¦‹ã¤ã‹ã‚‹ãŒã€
// apiConversationHistoryã«T2ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªã„ï¼ˆT3ã ã‹ã‚‰ï¼‰

// è§£æ±ºç­–: æœ€åˆã®userãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¢ƒç•Œã¨ã™ã‚‹
```

#### åˆ©ç‚¹

âœ… **ãƒ‡ãƒ¼ã‚¿ä¸€è²«æ€§**: ã‚µãƒãƒªãƒ¼/ãƒãƒ¼ã‚«ãƒ¼/ã‚¿ã‚°ãŒã™ã¹ã¦æ­£ã—ãç®¡ç†ã•ã‚Œã‚‹
âœ… **ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å¯¾ç­–**: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®ãšã‚Œã«å¯¾å¿œ
âœ… **ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆçµ±åˆ**: å®Œå…¨ã«åŒæœŸ
âœ… **ãƒ‡ãƒãƒƒã‚°å®¹æ˜“**: ãƒ­ã‚°ã§ä½•ãŒå‰Šé™¤ã•ã‚ŒãŸã‹è¿½è·¡å¯èƒ½
âœ… **å®‰å…¨æ€§**: ç›´æ¥æ“ä½œã‚’ç¦æ­¢

---

### é€²åŒ–7: å˜ä¸€ã—ãã„å€¤ â†’ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥æœ€é©åŒ–

#### Before: å…¨ãƒ¢ãƒ‡ãƒ«å…±é€š

```typescript
// å¤ã„æ–¹æ³•
const config = {
  contextWindow: 200000,
  threshold: 0.75  // ã™ã¹ã¦ã®ãƒ¢ãƒ‡ãƒ«ã§75%
}

// å•é¡Œ:
// - Claude Opus: é«˜æ€§èƒ½ã ãŒã—ãã„å€¤ãŒä½ã™ãã‚‹ï¼ˆã‚‚ã£ã¨ä½¿ãˆã‚‹ï¼‰
// - Claude Haiku: ä½ã‚³ã‚¹ãƒˆã ãŒã—ãã„å€¤ãŒé«˜ã™ãã‚‹ï¼ˆæ—©ã‚ã«å‡ç¸®ã™ã¹ãï¼‰
// - GPT-4 Turbo: 128kã ãŒ200kã®75%ã§è¨ˆç®—ï¼ˆä¸æ­£ç¢ºï¼‰
```

#### After: ãƒ¢ãƒ‡ãƒ«ã”ã¨ã®æœ€é©åŒ–

```typescript
// æ–°ã—ã„æ–¹æ³•ï¼ˆRoo Codeæ–¹å¼ï¼‰
interface ProfileConfig {
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š
  autoCondenseContext: boolean
  autoCondenseContextPercent: number  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã—ãã„å€¤

  // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
  profileThresholds: Record<string, number>

  // ç¾åœ¨ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«
  currentProfileId: string
}

class ProfileBasedContextManager {
  constructor(private config: ProfileConfig) {}

  // æœ‰åŠ¹ãªã—ãã„å€¤ã‚’æ±ºå®š
  getEffectiveThreshold(): number {
    const profileThreshold = this.config.profileThresholds[this.config.currentProfileId]

    // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®šãŒãªã„å ´åˆ
    if (profileThreshold === undefined) {
      return this.config.autoCondenseContextPercent
    }

    // -1 ã¯è¦ªè¨­å®šã‚’ç¶™æ‰¿
    if (profileThreshold === -1) {
      return this.config.autoCondenseContextPercent
    }

    // æœ‰åŠ¹ç¯„å›²ãƒã‚§ãƒƒã‚¯ï¼ˆ5-100%ï¼‰
    if (profileThreshold < MIN_CONDENSE_THRESHOLD || profileThreshold > MAX_CONDENSE_THRESHOLD) {
      console.warn(
        `Invalid threshold ${profileThreshold} for profile "${this.config.currentProfileId}". ` +
        `Using global default of ${this.config.autoCondenseContextPercent}%`
      )
      return this.config.autoCondenseContextPercent
    }

    // ã‚«ã‚¹ã‚¿ãƒ ã—ãã„å€¤
    return profileThreshold
  }

  // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†åˆ¤å®š
  async manageContext(
    messages: Message[],
    totalTokens: number
  ): Promise<ContextResult> {
    const contextWindow = this.getContextWindow()
    const threshold = this.getEffectiveThreshold()

    const contextPercent = (100 * totalTokens) / contextWindow

    // ã—ãã„å€¤ãƒã‚§ãƒƒã‚¯
    if (contextPercent < threshold) {
      return { messages }  // ä½•ã‚‚ã—ãªã„
    }

    // å‡ç¸®å®Ÿè¡Œ
    return await this.condense(messages)
  }

  // ãƒ¢ãƒ‡ãƒ«åˆ¥ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
  private getContextWindow(): number {
    const windows: Record<string, number> = {
      'claude-opus-4-5-20251101': 200000,
      'claude-3-7-sonnet-20250219': 200000,
      'claude-3-5-haiku-20241022': 200000,
      'gpt-4-turbo': 128000,
      'gpt-3.5-turbo': 16000
    }

    return windows[this.config.currentProfileId] || 200000
  }
}
```

#### æ¨å¥¨è¨­å®š

```typescript
// æ¨å¥¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š
const recommendedThresholds: Record<string, number> = {
  // Claude Opus 4: é«˜æ€§èƒ½ã€é«˜ã‚³ã‚¹ãƒˆ â†’ æœ€å¤§é™æ´»ç”¨
  'claude-opus-4-5-20251101': 80,  // 80%ã¾ã§ä½¿ã†

  // Claude Sonnet: ãƒãƒ©ãƒ³ã‚¹å‹ â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
  'claude-3-7-sonnet-20250219': 75,  // 75%ï¼ˆæ¨å¥¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

  // Claude Haiku: ä½ã‚³ã‚¹ãƒˆ â†’ æ—©ã‚ã«å‡ç¸®
  'claude-3-5-haiku-20241022': 60,  // 60%ã§å‡ç¸®é–‹å§‹

  // GPT-4 Turbo: 128k â†’ ã‚„ã‚„æ—©ã‚
  'gpt-4-turbo': 70,

  // GPT-3.5: 16k â†’ ã‹ãªã‚Šæ—©ã‚
  'gpt-3.5-turbo': 50,

  // ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«: è¦ªè¨­å®šã‚’ç¶™æ‰¿
  'custom-profile': -1
}

// VSCodeè¨­å®šã§ã®é‹ç”¨
// settings.json:
{
  "rooCode.autoCondenseContext": true,
  "rooCode.autoCondenseContextPercent": 75,  // ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š
  "rooCode.profileThresholds": {
    "claude-opus-4-5-20251101": 80,
    "claude-3-5-haiku-20241022": 60,
    "gpt-4-turbo": 70
  }
}
```

#### ãƒ¢ãƒ‡ãƒ«åˆ¥ã®æˆ¦ç•¥

```typescript
// ãƒ¢ãƒ‡ãƒ«ç‰¹æ€§ã«å¿œã˜ãŸæœ€é©åŒ–
class ModelAwareOptimizer {
  optimizeForModel(modelId: string): OptimizationStrategy {
    // Claude Opus: é«˜æ€§èƒ½ã€é«˜ã‚³ã‚¹ãƒˆ
    if (modelId.includes('opus')) {
      return {
        threshold: 80,  // é«˜ã‚
        condenseModel: modelId,  // åŒã˜ãƒ¢ãƒ‡ãƒ«ã§è¦ç´„ï¼ˆå“è³ªé‡è¦–ï¼‰
        compressionRatio: 0.7,   // 70%å‰Šæ¸›ç›®æ¨™
        keepMessages: 5          // å¤šã‚ã«ä¿æŒ
      }
    }

    // Claude Haiku: ä½ã‚³ã‚¹ãƒˆ
    if (modelId.includes('haiku')) {
      return {
        threshold: 60,  // ä½ã‚ï¼ˆæ—©ã‚ã«å‡ç¸®ï¼‰
        condenseModel: modelId,  // åŒã˜ãƒ¢ãƒ‡ãƒ«ï¼ˆã‚³ã‚¹ãƒˆé‡è¦–ï¼‰
        compressionRatio: 0.8,   // 80%å‰Šæ¸›ç›®æ¨™ï¼ˆç©æ¥µçš„ï¼‰
        keepMessages: 3          // æœ€å°é™
      }
    }

    // Claude Sonnet: ãƒãƒ©ãƒ³ã‚¹å‹
    if (modelId.includes('sonnet')) {
      return {
        threshold: 75,  // æ¨™æº–
        condenseModel: 'claude-3-5-haiku-20241022',  // å®‰ä¾¡ãªãƒ¢ãƒ‡ãƒ«ã§è¦ç´„
        compressionRatio: 0.75,  // 75%å‰Šæ¸›
        keepMessages: 3
      }
    }

    // GPTç³»: å°ã•ã‚ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
    if (modelId.includes('gpt')) {
      return {
        threshold: 70,  // ã‚„ã‚„ä½ã‚
        condenseModel: 'gpt-4-turbo',  // GPTã§è¦ç´„
        compressionRatio: 0.75,
        keepMessages: 3
      }
    }

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    return {
      threshold: 75,
      condenseModel: modelId,
      compressionRatio: 0.75,
      keepMessages: 3
    }
  }
}
```

#### åˆ©ç‚¹

âœ… **ã‚³ã‚¹ãƒˆæœ€é©åŒ–**: ãƒ¢ãƒ‡ãƒ«ã®ç‰¹æ€§ã«åˆã‚ã›ãŸè¨­å®š
âœ… **å“è³ªç¶­æŒ**: é«˜æ€§èƒ½ãƒ¢ãƒ‡ãƒ«ã‚’æœ€å¤§é™æ´»ç”¨
âœ… **æŸ”è»Ÿæ€§**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã«èª¿æ•´å¯èƒ½
âœ… **ç¶™æ‰¿**: -1ã§è¦ªè¨­å®šã‚’ç¶™æ‰¿ï¼ˆéšå±¤çš„è¨­å®šï¼‰
âœ… **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: ç„¡åŠ¹ãªå€¤ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

---

## ãªãœã“ã®é€²åŒ–ãŒå¿…è¦ã ã£ãŸã‹

### 1. LLMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æˆç†Ÿ

**2023-2024**: å®Ÿé¨“çš„ãªãƒ‡ãƒ¢ãŒä¸­å¿ƒ
- çŸ­ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³
- é™å®šçš„ãªã‚¿ã‚¹ã‚¯
- ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—å“è³ª

**2025**: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ã®è¦æ±‚
- é•·æ™‚é–“ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆæ•°æ™‚é–“ã€œæ•°æ—¥ï¼‰
- è¤‡é›‘ãªã‚¿ã‚¹ã‚¯ï¼ˆãƒãƒ«ãƒã‚¹ãƒ†ãƒƒãƒ—ã€è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
- ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºå“è³ªï¼ˆç›£æŸ»ã€å¾©å…ƒã€ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆï¼‰

### 2. ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®æ‹¡å¤§

**2023**: 4k-16kãƒˆãƒ¼ã‚¯ãƒ³
â†’ å˜ç´”å‰Šé™¤ã§ã‚‚ä½•ã¨ã‹ãªã£ãŸ

**2024-2025**: 128k-200kãƒˆãƒ¼ã‚¯ãƒ³
â†’ è³¢ãä½¿ã‚ãªã„ã¨ç„¡é§„ã€ã‹ã¤åˆ¶é™ã«é”ã™ã‚‹ã®ãŒæ—©ã„

### 3. Native Toolsãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®ç™»å ´

**Before**: åŸºæœ¬çš„ãªfunction calling

**After**: è¤‡é›‘ãªtool_use/tool_resultãƒšã‚¢ã€reasoning_content
â†’ ãƒ—ãƒ­ãƒˆã‚³ãƒ«æº–æ‹ ãŒå¿…é ˆ

### 4. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆçš„ãªä½¿ç”¨ã®å¢—åŠ 

**Before**: 1å¾€å¾©ã®è³ªå•å¿œç­”

**After**: é•·æœŸçš„ãªã‚¿ã‚¹ã‚¯å®Ÿè¡Œï¼ˆplanning â†’ executing â†’ reflectingï¼‰
â†’ ãƒ•ã‚§ãƒ¼ã‚ºç®¡ç†ã€æ¨©é™ç®¡ç†ãŒå¿…è¦

### 5. ã‚³ã‚¹ãƒˆæ„è­˜ã®é«˜ã¾ã‚Š

**Before**: å®Ÿé¨“ã ã‹ã‚‰ã‚³ã‚¹ãƒˆã¯æ°—ã«ã—ãªã„

**After**: ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³é‹ç”¨ã§ã‚³ã‚¹ãƒˆãŒé‡è¦
â†’ ãƒ¢ãƒ‡ãƒ«åˆ¥æœ€é©åŒ–ã€åŠ¹ç‡çš„ãªåœ§ç¸®ãŒå¿…è¦

### 6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹

**Before**: å€‹äººåˆ©ç”¨ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯å¾Œå›ã—

**After**: ä¼æ¥­åˆ©ç”¨ã€è¦åˆ¶å¯¾å¿œãŒå¿…é ˆ
â†’ ç›£æŸ»è¨¼è·¡ã€æ¨©é™ç®¡ç†ã€å®‰å…¨ãªãƒ„ãƒ¼ãƒ«æŠ•å½±

---

## å®Ÿéš›ã®å½±éŸ¿

### ãƒˆãƒ¼ã‚¯ãƒ³å‰Šæ¸›åŠ¹æœ

```typescript
// Beforeï¼ˆå˜ç´”å‰Šé™¤ï¼‰
åˆæœŸ: 12ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â‰ˆ 3000ãƒˆãƒ¼ã‚¯ãƒ³
å‰Šé™¤å¾Œ: 6ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â‰ˆ 1500ãƒˆãƒ¼ã‚¯ãƒ³
å‰Šæ¸›ç‡: 50%
æƒ…å ±æå¤±: å¤§ï¼ˆé‡è¦ãªæ–‡è„ˆãŒå¤±ã‚ã‚Œã‚‹ï¼‰

// Afterï¼ˆCondensationï¼‰
åˆæœŸ: 12ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â‰ˆ 3000ãƒˆãƒ¼ã‚¯ãƒ³
å‡ç¸®å¾Œ: 5ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚µãƒãƒªãƒ¼1 + ä¿æŒ4ï¼‰ â‰ˆ 900ãƒˆãƒ¼ã‚¯ãƒ³
å‰Šæ¸›ç‡: 70%
æƒ…å ±æå¤±: å°ï¼ˆã‚µãƒãƒªãƒ¼ã«é‡è¦æƒ…å ±ãŒå«ã¾ã‚Œã‚‹ï¼‰
```

### ã‚³ã‚¹ãƒˆå‰Šæ¸›

```typescript
// Before: å¸¸ã«ãƒ•ãƒ«ãƒ¢ãƒ‡ãƒ«
Claude Opusä½¿ç”¨: ã™ã¹ã¦ã®è¦ç´„ã«Opusä½¿ç”¨
æœˆé¡ã‚³ã‚¹ãƒˆ: $500

// After: å°‚ç”¨ãƒ¢ãƒ‡ãƒ«
ãƒ¡ã‚¤ãƒ³: Claude Opus
è¦ç´„: Claude Haikuï¼ˆ1/10ã®ã‚³ã‚¹ãƒˆï¼‰
æœˆé¡ã‚³ã‚¹ãƒˆ: $350

å‰Šæ¸›: 30% âœ…
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Š

```typescript
// Before: ã™ã¹ã¦ã®ãƒ„ãƒ¼ãƒ«ãŒå¸¸ã«è¦‹ãˆã‚‹
å±é™ºæ“ä½œã®èª¤å®Ÿè¡Œ: æœˆ10ä»¶

// After: å‹•çš„ãƒ„ãƒ¼ãƒ«æŠ•å½±
å±é™ºæ“ä½œã®èª¤å®Ÿè¡Œ: æœˆ0ä»¶

æ”¹å–„: 100% âœ…
```

### é–‹ç™ºåŠ¹ç‡

```typescript
// Before: ãƒ‡ãƒ¼ã‚¿æå¤±ã§ãƒ‡ãƒãƒƒã‚°å›°é›£
ãƒã‚°ä¿®æ­£æ™‚é–“: å¹³å‡4æ™‚é–“

// After: éç ´å£Šçš„ç®¡ç†ã§ãƒ‡ãƒãƒƒã‚°å®¹æ˜“
ãƒã‚°ä¿®æ­£æ™‚é–“: å¹³å‡1æ™‚é–“

æ”¹å–„: 75% âœ…
```

---

## ã¾ã¨ã‚: Context Management 1å¹´é–“ã®é€²åŒ–

| è¦³ç‚¹ | 1å¹´å‰ï¼ˆ2023-2024ï¼‰ | ç¾åœ¨ï¼ˆ2025ï¼‰ | æ”¹å–„åº¦ |
|------|------------------|-------------|--------|
| **ãƒ‡ãƒ¼ã‚¿ç®¡ç†** | å‰Šé™¤ | ã‚¿ã‚°ä»˜ã‘ | â˜…â˜…â˜…â˜…â˜… |
| **åœ§ç¸®** | æ©Ÿæ¢°çš„ | AIè¦ç´„ | â˜…â˜…â˜…â˜…â˜… |
| **State** | ãƒ•ãƒ©ãƒƒãƒˆ | éšå±¤çš„ | â˜…â˜…â˜…â˜…â˜† |
| **ãƒ„ãƒ¼ãƒ«** | é™çš„ | å‹•çš„æŠ•å½± | â˜…â˜…â˜…â˜…â˜… |
| **ãƒ—ãƒ­ãƒˆã‚³ãƒ«** | åŸºæœ¬ | Native Toolså¯¾å¿œ | â˜…â˜…â˜…â˜…â˜† |
| **ç®¡ç†** | ç›´æ¥æ“ä½œ | MessageManager | â˜…â˜…â˜…â˜…â˜… |
| **æœ€é©åŒ–** | å˜ä¸€ | ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ | â˜…â˜…â˜…â˜…â˜† |
| **ç·åˆ** | ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—å“è³ª | ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å“è³ª | â˜…â˜…â˜…â˜…â˜… |

---

