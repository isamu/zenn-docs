---
title: "FriendlyEats-vue3 - Firebase9 Vue.js 3 Turorial"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Firebase, Vue.js, JavaScript]
published: true
---

# FriendlyEats-vue3

FriendlyEats-vue3ã¯ã€ FriendlyEats-vueã‚’ãƒ™ãƒ¼ã‚¹ã«Vue3ã¨Firebase SDK v9ã«å¯¾å¿œã—ãŸFirebaseã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã™ã€‚Vueã¨Firebaseã¯2020, 2021å¹´ã«å¤§ãããƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å¤‰æ›´ã—ã¦æ—¢å­˜ã®APIã¨äº’æ›æ€§ãŒãªããªã‚Šã¾ã—ãŸã€‚ã“ã‚Œã‹ã‚‰Firebaseã‚„Vueã‚’é–‹ç™ºã™ã‚‹ã«ã¯ã€ã“ã‚Œã‚‰ã®çµ„ã¿åˆã‚ã›ã‚’ä½¿ã†ã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’ä½¿ã£ãŸã€ã“ã‚Œã‚‰ã®ä½¿ã„æ–¹ã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚

ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®ã‚½ãƒ¼ã‚¹ã¯ã“ã¡ã‚‰ã«ã‚ã‚Šã¾ã™ã€‚

https://github.com/isamu/FriendlyEats-vue3

## FriendlyEats-vue3 ã«ã¤ã„ã¦

FriendlyEats-vue3ã¯ã€Vue 3ã‚’ä½¿ã£ãŸFirebase / Cloud Firestoreã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç”¨ã®ã‚¢ãƒ—ãƒªã§ã™ã€‚Cloud Firestoreã‚’å­¦ç¿’ã™ã‚‹ãŸã‚ã«æœ€å°é™ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ã™ã‚‹ã ã‘ã§Cloud Firestoreã‚’ä½¿ã£ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![sample](http://to-kyo.to/~isamu/code/1.jpg)

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ä»¥ä¸‹ã®ã“ã¨ã‚’å­¦ç¿’ã—ã¾ã™ã€‚
- Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰Cloud Firestoreã¸ã®èª­ã¿æ›¸ãã‚’ã™ã‚‹
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«Cloud Firestoreã®ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã‚’å—ã‘å–ã‚‹
- Firebaseã®ãƒ¦ãƒ¼ã‚¶èªè¨¼ã‚’ä½¿ã£ãŸã‚Šã€Security Rulesã‚’ä½¿ã£ã¦Cloud Firestoreã®ãƒ‡ãƒ¼ã‚¿ã‚’å®‰å…¨ã«èª­ã¿æ›¸ãã™ã‚‹
- Cloud Firestoreã®è¤‡é›‘ãªã‚¯ã‚¨ãƒªãƒ¼ã‚’æ›¸ã

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’å§‹ã‚ã‚‹ã«å½“ãŸã£ã¦ã€å¿…è¦ãªé–‹ç™ºç’°å¢ƒã¯ä»¥ä¸‹ã¨ãªã‚Šã¾ã™ã€‚

- Gitã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã€‚GitHubã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚‚ã‚ã‚Œã°ç”¨æ„ã—ã¦ãã ã•ã„
- Node.jsã¨npm \- Nodeã¯version 14ã‚’ãŠè–¦ã‚ã—ã¾ã™
- IDEã‚„ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã€‚ãŸã¨ãˆã° Emacs, vim, WebStorm, Atom, VS Code, Sublime ãªã©ã‹ã‚‰ãŠå¥½ããªã‚‚ã®ã‚’é¸ã‚“ã§ãã ã•ã„

## Firebase projectã®ä½œæˆã¨è¨­å®š

### Firebase projectã‚’ä½œæˆã™ã‚‹
1. [Firebaseã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«](https://console.firebase.google.com)ä¸Šã§ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™
1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåå‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚ã€ŒFriendlyEatsã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„
1. å…¥åŠ›ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã®ä¸‹ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆå¤‰æ›´å¯èƒ½ã§ã™ï¼‰
ä½œæˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã¯å¿˜ã‚Œãªã„ã‚ˆã†ã«ï¼
1. [ç¶šè¡Œ]ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™
1. Google ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ç”»é¢ã§ã€Œä»Šã¯å¿…è¦ãªã„ã€ã‚’é¸æŠã—ã¾ã™
1. [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ]ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™
1. ã€Œæ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æº–å‚™ãŒã§ãã¾ã—ãŸã€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚[ç¶šè¡Œ]ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™

> é‡è¦: ä½œæˆã•ã‚ŒãŸ Firebaseã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€ŒFriendlyEatsã€ã¨ã„ã†åå‰ã§ã™ãŒã€Firebaseã¯è‡ªå‹•çš„ã«ã€Œfriendlyeats-1234ã€ã®ã‚ˆã†ãªå›ºæœ‰ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’å‰²ã‚Šå½“ã¦ã¾ã™ã€‚ã“ã®å›ºæœ‰ã®IDã¯ã€ã‚ãªãŸã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è­˜åˆ¥ã™ã‚‹ã®ã«å¿…è¦ã§ã™ï¼ˆCLIãªã©ã§ï¼‰ã€‚ã€ŒFriendlyEatsã€ã¯å˜ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åå‰ã§ã™ã€‚

ã“ã‚Œã‹ã‚‰ä½œæˆã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€ã‚¦ã‚§ãƒ–ä¸Šã§ä½¿ãˆã‚‹Firebaseã®ã‚µãƒ¼ãƒ“ã‚¹ã®ã†ã¡ã„ãã¤ã‹ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

- Firebase Authentication \- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç°¡å˜ã«ç®¡ç†/è­˜åˆ¥ã—ã¾ã™
- Cloud Firestore \- ã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã«æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã€ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚ŒãŸæ™‚ã¯å³åº§ã«é€šçŸ¥ã—ã¾ã™
- Firebase Hosting \- é™çš„ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã—ã¾ã™

ä»¥ä¸‹ã§ã¯ã€Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç”¨ã„ãŸã€ŒFirebase Authã€ãŠã‚ˆã³ã€ŒCloud Firestoreã€ã®è¨­å®šæ–¹æ³•ã«ã¤ã„ã¦ã€é †ã‚’è¿½ã£ã¦èª¬æ˜ã—ã¾ã™ã€‚

### Anonymous Auth (åŒ¿åèªè¨¼)ã‚’æœ‰åŠ¹ã«ã™ã‚‹

èªè¨¼ã¯ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®ç„¦ç‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ä½•ã‚‰ã‹ã®å½¢å¼ã®èªè¨¼ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã¯é‡è¦ã§ã™ã€‚
ã“ã®ã‚¢ãƒ—ãƒªã§ã¯ã€åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã¤ã¾ã‚Šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ˜ç¤ºçš„ãªæ“ä½œã‚’ã™ã‚‹ã“ã¨ãªããƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚
 
ãã®ãŸã‚ã«ã¯ã€åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ãšã€‚

1. ãƒ–ãƒ©ã‚¦ã‚¶ã§ã€[Firebaseã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«](https://console.firebase.google.com)ã‚’è¡¨ç¤ºã—ã¾ã™
1. å·¦ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€Œé–‹ç™ºã€ã®ã€ŒAuthenticationã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™
1. ã€Œãƒ­ã‚°ã‚¤ãƒ³æ–¹æ³•ã€ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™
1. ã€Œãƒ­ã‚°ã‚¤ãƒ³ãƒ—ãƒ­ãƒã‚¤ãƒ€ã€ã®ã€ŒåŒ¿åã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€Œæœ‰åŠ¹ã€ã«ã—ã¦ãã ã•ã„
1. æœ€å¾Œã«[ä¿å­˜]ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™

![fee6c3ebdf904459.png](http://to-kyo.to/~isamu/code/2.png)

![FriendlyEats](http://to-kyo.to/~isamu/code/3.png "åŒ¿åèªè¨¼")


ã“ã‚Œã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒWebã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãã«ã€åŒ¿åã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚è©³ç´°ã¯ã€[åŒ¿åèªè¨¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://firebase.google.com/docs/auth/web/anonymous-auth)ã‚’ãŠèª­ã¿ãã ã•ã„ã€‚
 
### Cloud Firestoreã‚’æœ‰åŠ¹ã«ã™ã‚‹
ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®æƒ…å ±ã‚„è©•ä¾¡ã‚’ä¿å­˜ã€æ›´æ–°æƒ…å ±ã‚’å—ã‘å–ã‚‹ãŸã‚ã«ã€Cloud Firestoreï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ¼ãƒ™ãƒ¼ã‚¹ï¼‰ã‚’ä½¿ã„ã¾ã™ã€‚

ãã®ãŸã‚ã«ã¯ã€Cloud Firestoreã‚’æœ‰åŠ¹ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

1. ãƒ–ãƒ©ã‚¦ã‚¶ã§ã€Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™
1. å·¦ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€Œé–‹ç™ºã€ã®ã€ŒDatabaseã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™
1. Cloud Firestoreãƒšã‚¤ãƒ³ã§ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™
![8c5f57293d48652.png](http://to-kyo.to/~isamu/code/4.png)
1. ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã€Œãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§é–‹å§‹ã€ã‚’é¸æŠã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã«é–¢ã™ã‚‹å…è²¬äº‹é …ã‚’èª­ã‚“ã å¾Œã€[æ¬¡ã¸]ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™
1. ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ãŒã€å¾Œã‹ã‚‰å¤‰æ›´ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ï¼‰ã€[å®Œäº†]ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™

ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€é–‹ç™ºä¸­ã«Cloud Firestoreã¸æ›¸ãè¾¼ã¿ãŒè‡ªç”±ã«ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã¯ã€ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®å¾ŒåŠã§ãŠã“ãªã„ã¾ã™ã€‚

![620b95f93bdb154a.png](http://to-kyo.to/~isamu/code/5.png)


# 3. ã‚µãƒ³ãƒ—ãƒ«ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å–å¾—ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ GitHub ãƒ¬ãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¾ã™

```sh
git clone https://github.com/isamu/FriendlyEats-vue3
```
* è‡ªåˆ†ã®å¤‰æ›´ã‚’GitHubã§ç®¡ç†ã—ãŸã„å ´åˆã«ã¯ã€Forkã—ã¦cloneã—ã¦ãã ã•ã„


ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ğŸ“FriendlyEats-vue3ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«Cloneã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä»¥å¾Œã€ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã§ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚


```sh
cd FriendlyEats-vue3
```

### npmã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

npmã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```sh
npm install
```
### Firebaseã®è¨­å®šã‚’å–å¾—ã— firebase.js ã‚’æ›¸ãæ›ãˆã‚‹

Firebaseã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰è¨­å®šã‚’å–å¾—ã—ã€src/firebase/firebase.js ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚

- [Firebaseã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«](https://console.firebase.google.com) ã‚’é–‹ã„ã¦ã€ŒFriendlyEatsã€ã‚’é¸æŠã—ã¾ã™
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ã€ŒGet started by adding Firebase to your appã€ã‹ã‚‰ã€ŒWebã€ ã‚’é¸æŠã—ã¾ã™
- ã€ŒRegister appã€ã§ã€ã€ŒApp nicknameã€ã«ã€ŒFriendlyEatsã€ã¨å…¥åŠ›ã—ã€ã€ŒAlso set up Firebase Hostingã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã€ã€ŒRegister appã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™
- å†åº¦ã€[Firebaseã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«](https://console.firebase.google.com) ã‚’é–‹ã„ã¦ã€ŒFriendlyEatsã€ã‚’é¸æŠã—ã¾ã™
- å·¦å´ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒProjectOverviewã€ã®å·¦æ¨ªã®ã€Œè¨­å®šã‚¢ã‚¤ã‚³ãƒ³ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ŒProject settingsã€ã‚’é¸æŠã—ã¾ã™
- ã‚¢ãƒ—ãƒªã®è¨­å®šç”»é¢ï¼ˆSettingsï¼‰ã® å…¨èˆ¬ã‚¿ãƒ– ï¼ Firebase SDK snippet ï¼ æ§‹æˆ ã‚’é¸æŠã—ã¾ã™
- `const firebaseConfig` ã§å§‹ã¾ã‚‹éƒ¨åˆ†ã‚’ã‚³ãƒ”ãƒ¼ã—ã€src/firebase/firebase.js å†…ã®ç›¸å½“ã™ã‚‹éƒ¨åˆ†ã‚’ç½®ãæ›ãˆã¾ã™  

### ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹

IDEï¼ˆWebStormã€Atomã€Sublimeã€Visual Studio Code ...ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€ğŸ“FriendlyEats-vue3ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é–‹ãã‹ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ã€ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æƒ…å ±ã¨ã‚ªã‚¹ã‚¹ãƒ¡æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹ã‚¢ãƒ—ãƒªã®æœªå®Œæˆãªãƒ¢ãƒƒã‚¯ã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’é€šã—ã¦ã“ã®ã‚¢ãƒ—ãƒªã‚’å®Ÿè£…ã—ã¦ã„ãã®ã§ã€ã“ã®ãƒ¢ãƒƒã‚¯ã‚³ãƒ¼ãƒ‰ã‚’ç·¨é›†ã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚


## Firebase CLI (ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«)ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Firebaseã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ï¼ˆCLIï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€Webã‚¢ãƒ—ãƒªã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§é–‹ç™ºã—ãŸã‚Šã€Firebase Hostingã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

Note: CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã«ã¯ã€é€šå¸¸NodeJSã«ä»˜å±ã—ã¦ã„ã‚‹npmã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

1 . æ¬¡ã®npmã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```sh
npm -g install firebase-tools
```

> å‹•ä½œã—ã¾ã›ã‚“ã‹ï¼Ÿ npmã®permissionã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

2 . æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€CLIãŒæ­£ã—ãã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```sh
firebase --version
```

Firebase CLIã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒv9.0.0ä»¥é™ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

3 . æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€Firebase CLIã‚’èªè¨¼ã—ã¾ã™ã€‚

```sh
firebase login
```

Firebase Hostingã®ã‚¢ãƒ—ãƒªã®è¨­å®šã‚’ã‚¢ãƒ—ãƒªã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å–å¾—ã™ã‚‹ã‚ˆã†ã«ã€ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¨­å®šã—ã¾ã—ãŸã€‚ãŸã ã—ã€ã“ã‚Œã‚’è¡Œã†ã«ã¯ã€ã‚¢ãƒ—ãƒªã‚’Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é–¢é€£ä»˜ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚


4 . ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãŒã€å…ˆã»ã©cloneã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ¼ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆé€šå¸¸FriendlyEats-vueãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ¼ã€‚pwdã§ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ¼ã‚’ç¢ºèªã§ãã¾ã™ï¼‰

5 . æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€ã‚¢ãƒ—ãƒªã‚’Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é–¢é€£ä»˜ã‘ã¾ã™ã€‚

```sh
firebase use --add
```

6 . ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’é¸æŠã—ã€Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’æŒ‡å®šã—ã¾ã™ã€‚
ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¯ã€è¤‡æ•°ã®ç’°å¢ƒï¼ˆæœ¬ç•ªã€ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãªã©ï¼‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹å ´åˆã«å½¹ç«‹ã¡ã¾ã™ã€‚ãŸã ã—ã€ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€`default`ã¨ã„ã†ã‚¨ã‚¤ãƒªã‚¢ã‚¹åã‚’å…¥åŠ›ã—ã¾ã™ï¼ˆã‚¹ãƒšãƒ«ã‚’é–“é•ãˆã‚‹ã¨å¾Œã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ“ä½œç­‰ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ï¼‰ã€‚

7 . ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã®æ®‹ã‚Šã®æŒ‡ç¤ºã«å¾“ã£ã¦ãã ã•ã„ã€‚

## Vueã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•ã™ã‚‹
ã‚¢ãƒ—ãƒªã§å®Ÿéš›ã«ä½œæ¥­ã‚’é–‹å§‹ã™ã‚‹æº–å‚™ãŒã§ãã¾ã—ãŸï¼ã‚¢ãƒ—ãƒªã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã—ã¾ã—ã‚‡ã†ï¼

1 . æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã®CLIã§å®Ÿè¡Œã—ã¾ã™:

```sh
npm run serve
```

2 . æˆåŠŸã™ã‚‹ã¨æ¬¡ã®æ–‡ã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™

```sh
  - Local:   http://localhost:8080/ 
```

Vueã‚µãƒ¼ãƒãŒãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•ã—ã¦ã„ã¾ã™ã€‚ ãƒ–ãƒ©ã‚¦ã‚¶ http://localhost:8080 ã‚’é–‹ãã¨ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ Vueã‚’èµ·å‹•ã™ã‚‹ã¨è‡ªå‹•çš„ã«é–‹ãå ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚8080ã¨ã„ã†æ•°å­—ã¯å°‘ã—åˆ¥ã®ç•ªå·ã«ãªã£ã¦ã„ã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚

3 . ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:8080 ã‚’è¦‹ã‚‹

ã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã®Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«æ¥ç¶šã•ã‚Œã¦ã„ã‚‹FriendlyEatsã‚¢ãƒ—ãƒªãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆåˆå›èµ·å‹•æ™‚ã¯ã—ã°ã‚‰ãæ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰ã€‚

ã‚¢ãƒ—ãƒªã¯è‡ªå‹•çš„ã«ã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã®Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«æ¥ç¶šã—ã€åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚

![anon](http://to-kyo.to/~isamu/code/7.png)


## Cloud Firestoreã¸ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãè¾¼ã¿

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€Cloud Firestoreã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã¿ã¾ã™ã€‚Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸Šã§æ‰‹å‹•ã§ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã‚’è¡Œã†ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€Cloud Firestoreã®åŸºæœ¬çš„ãªæ›¸ãè¾¼ã¿ã‚’å­¦ç¿’ã™ã‚‹ç‚ºã«ã€ã‚¢ãƒ—ãƒªè‡ªä½“ã§ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ/å…¥åŠ›ã‚’è¡Œã„ã¾ã™ã€‚

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

Firestoreãƒ‡ãƒ¼ã‚¿ã¯ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã€ãŠã‚ˆã³ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚å„ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æƒ…å ±ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ã€`restaurants`ã¨å‘¼ã°ã‚Œã‚‹æœ€ä¸Šä½ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜ã—ã¾ã™ã€‚

![data](http://to-kyo.to/~isamu/code/8.png =250x)

ãã—ã¦ã€å„ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’`ratings`ã¨åä»˜ã‘ãŸã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜ã—ã¾ã™ã€‚

![data](http://to-kyo.to/~isamu/code/9.png =250x)

> Tip: Firestoreãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã”è¦§ãã ã•ã„ã€‚

### Firestoreã«ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æƒ…å ±ã‚’è¿½åŠ ã™ã‚‹

ã“ã®ã‚¢ãƒ—ãƒªã®ä¸»ãªãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯restaurantã§ã™ã€‚`restaurants`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¾ã—ã‚‡ã†ã€‚

1. cloneã—ãŸã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã® `src/components/FriendlyEats.Data.js` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã¾ã™
1. `addRestaurant` é–¢æ•°ã‚’æ¢ã—ã¾ã™
1. é–¢æ•°å…¨ä½“ã‚’ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«ç½®ãæ›ãˆã¾ã™

[FriendlyEats.Data.js](https://github.com/isamu/FriendlyEats-vue3/blob/master/src/components/FriendlyEats.Data.js#L5-L9.js)

```js
export const addRestaurant = (data) => {
  return addDoc(collection(db, "restaurants"), data);
};
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚Šã€`restaurants`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«æ–°ã—ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ(ãƒ‡ãƒ¼ã‚¿)ãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã¯JavaScriptã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚

ã“ã®é–¢æ•°ã¯ã€æ¬¡ã®ã‚ˆã†ãªå‡¦ç†ã‚’ã—ã¾ã™ã€‚


1. ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¼•æ•°ã¨ã—ã¦å–å¾—ã—ã¾ã™
1. Cloud Firestoreã®`restaurants`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®å‚ç…§ã‚’å–å¾—ã—ã¾ã™
1. å¼•æ•°ã§å—ã‘å–ã£ãŸãƒ‡ãƒ¼ã‚¿ã¯ã€ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ ã«è‡ªå‹•ç”Ÿæˆã—ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¿½åŠ ã—ã¾ã™

(* å®Ÿéš›ã«ã©ã®ã‚ˆã†ã«ãƒ‡ãƒ¼ã‚¿ãŒç”Ÿæˆã•ã‚Œã‚‹ã‹èˆˆå‘³ãŒã‚ã‚‹äººã¯ `src/FriendlyEats/FriendlyEats.Mock.js` ã®`addMockRestaurants`ã¨`getRandomRestaurant`ã®å®Ÿè£…ã‚’è¦‹ã¦ãã ã•ã„ã€‚)

### restaurantsæƒ…å ±ã‚’è¿½åŠ ã—ã‚ˆã†!

1. ãƒ–ãƒ©ã‚¦ã‚¶ã®FriendlyEatsã‚¢ãƒ—ãƒªã«æˆ»ã‚Šã€ç”»é¢ã‚’æ›´æ–°ã—ã¾ã™
1. ã€ŒIMPORT DATAã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™

ã¾ã ç”»é¢ã«ã¯ä½•ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ãŒã€Cloud Firestoreã«ã¯ãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

å®Ÿéš›ã«ã¿ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã€ŒCloud Firestoreã€ã‚¿ãƒ–ã«ç§»å‹•ã™ã‚‹ã¨ã€`restaurants`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«æ–°ã—ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![f06898b9d6dd4881.png](http://to-kyo.to/~isamu/code/10.png)

ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ï¼Webã‚¢ãƒ—ãƒªã‹ã‚‰Cloud Firestoreã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã¿ãŒæˆåŠŸã—ã¾ã—ãŸï¼ï¼

æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€Cloud Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚¢ãƒ—ãƒªã«è¡¨ç¤ºã™ã‚‹æ–¹æ³•ã‚’å­¦ç¿’ã—ã¾ã™ã€‚


## Cloud Firestore ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€Cloud Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚¢ãƒ—ãƒªã«è¡¨ç¤ºã™ã‚‹æ–¹æ³•ã‚’å­¦ç¿’ã—ã¾ã™ã€‚ 2ã¤ã®é‡è¦ãªæ‰‹é †ã¯ã€ã‚¯ã‚¨ãƒªã®ä½œæˆã¨ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ ã§ã™ã€‚ã“ã®ãƒªã‚¹ãƒŠãƒ¼ã«ã¯ã€ã‚¯ã‚¨ãƒªã«ä¸€è‡´ã™ã‚‹ã™ã¹ã¦ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒé€šçŸ¥ã•ã‚Œã€æ›´æ–°ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å—ä¿¡ã—ã¾ã™ã€‚

æœ€åˆã«ã€ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ãªã„ãƒªã‚¹ãƒˆã‚’æä¾›ã™ã‚‹ã‚¯ã‚¨ãƒªã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ã€‚

1. `src/components/FriendlyEats.Data.js` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã¾ã™
1. `getAllRestaurants` é–¢æ•°ã‚’æ¢ã—ã¾ã™
1. é–¢æ•°å…¨ä½“ã‚’ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«ç½®ãæ›ãˆã¾ã™


[FriendlyEats.Data.js](https://github.com/isamu/FriendlyEats-vue3/blob/master/src/components/FriendlyEats.Data.js#L11-L15.js)

```js
export const getAllRestaurants = () => {
  return query(collection(db, "restaurants"), orderBy("avgRating", "desc"), limit(50));
};
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€`restaurants`ã¨ã„ã†åã®ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰æœ€å¤§50ä»¶ã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚’å–å¾—ã™ã‚‹ã‚¯ã‚¨ãƒªã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯è©•ä¾¡ã®å¹³å‡é †ï¼ˆç¾åœ¨ã¯ã™ã¹ã¦ã‚¼ãƒ­ï¼‰ã«ä¸¦ã¹ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ã‚¯ã‚¨ãƒªã‚’å®šç¾©å¾Œã€ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’è¡Œã†`getDocumentsInQuery`é–¢æ•°ã«ã“ã®ã‚¯ã‚¨ãƒªã‚’æ¸¡ã—ã¾ã™ã€‚

ã“ã‚Œã‚’è¡Œã†ã«ã¯ã€ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚

- `src/components/FriendlyEats.Data.js` ã‚’é–‹ãã¾ã™
- `getDocumentsInQuery` é–¢æ•°ã‚’æ¢ã—ã¾ã™
- é–¢æ•°å…¨ä½“ã‚’ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«ç½®ãæ›ãˆã¾ã™

[FriendlyEats.Data.js](https://github.com/isamu/FriendlyEats-vue3/blob/master/src/components/FriendlyEats.Data.js#L18-L22.js)

```js
export const getDocumentsInQuery = (query, renderer) => {
  return onSnapshot(query, (snapshot) => {
    if (!snapshot.size) return renderer.empty();
    snapshot.docChanges().forEach((change) => {
      if (change.type === "removed") {
        renderer.remove(change.doc);
      } else {
        renderer.display(change.doc);
      }
    });
  });
};
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€ã‚¯ã‚¨ãƒªã®çµæœã«å¤‰æ›´ãŒã‚ã‚‹ãŸã³ã«`onSnapshot`ã‚’ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å‘¼ã³å‡ºã—ã¾ã™ã€‚

- æœ€åˆã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯ã€ã‚¯ã‚¨ãƒªã®çµæœã€å…¨ä½“ã®ãƒ‡ãƒ¼ã‚¿ã‚’`snapshot`ã¨ã—ã¦æ¸¡ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€Cloud Firestoreã®`restaurants`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“(50ä»¶)ã‚’æ„å‘³ã—ã¾ã™ã€‚ãã—ã¦`change`ã«ã¯ã€å…¨ã¦ã®å€‹ã€…ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ¸¡ã•ã‚Œã€ãã‚Œã‚’`renderer.display`é–¢æ•°ã«æ¸¡ã—ã¾ã™ã€‚
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚ŒãŸæ™‚ã«ã¯ã€`change.type`ã¯`removed`ã¨ãªã‚Šã¾ã™ã€‚ã—ãŸãŒã£ã¦ã€ã“ã®å ´åˆã€UIã‹ã‚‰ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

ä¸¡æ–¹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ãŸã®ã§ã€ã‚¢ãƒ—ãƒªã‚’æ›´æ–°ã—ã€Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å‰ã«è¡¨ç¤ºã—ãŸãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æƒ…å ±ãŒWebã‚¢ãƒ—ãƒªã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ­£å¸¸ã«å®Œäº†ã—ãŸå ´åˆã€Webã‚¢ãƒ—ãƒªã¯Cloud Firestoreã§ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿æ›¸ãã§ãã¦ã„ã¾ã™ã€‚

ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ãƒªã‚¹ãƒˆãŒå¤‰æ›´ã•ã‚Œã‚‹ã¨ã€ã“ã®ãƒªã‚¹ãƒŠãƒ¼ã¯è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã™ã€‚
Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ç§»å‹•ã—ã¦ã€ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚’æ‰‹å‹•ã§å‰Šé™¤ã™ã‚‹ã‹ã€åå‰ã‚’å¤‰æ›´ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ã‚µã‚¤ãƒˆä¸Šã®ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°ã•ã‚Œã¾ã™ã€‚

Note: `getDocs()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€æ›´æ–°é€šçŸ¥ã‚’å¸¸æ™‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«å—ã‘å–ã‚‹ã®ã§ã¯ãªãã€Cloud Firestoreã‹ã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä¸€åº¦ã ã‘å–å¾—ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

![data](http://to-kyo.to/~isamu/code/11.jpg =250x)

## ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹

ã“ã“ã¾ã§ã¯ã€`onSnapshot`ã‚’ä½¿ç”¨ã—ã¦æ›´æ–°ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å–å¾—ã™ã‚‹æ–¹æ³•ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚
ã¤ãã¯ã€ã‚¢ãƒ—ãƒªå†…ã®ç‰¹å®šã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã«ãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ã‚‡ã†ã€‚

1. `src/components/FriendlyEats.Data.js` ã‚’é–‹ãã¾ã™
1. `getRestaurant`é–¢æ•°ã‚’æ¢ã—ã¾ã™
1. é–¢æ•°å…¨ä½“ã‚’ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«ç½®ãæ›ãˆã¾ã™

[FriendlyEats.Data.js](https://github.com/isamu/FriendlyEats-vue3/blob/master/src/components/FriendlyEats.Data.js#L25-L29.js)

```js
export const getRestaurant = (id) => {
  return getDoc(doc(db, `restaurants/${id}`));
};
```

ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã™ã‚‹ã¨ã€å„ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ãƒªã‚¹ãƒˆå†…ã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã ã‘ã§ã€ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®è©³ç´°ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![restrant](http://to-kyo.to/~isamu/code/12.png)

ç¾æ™‚ç‚¹ã§ã¯è©•ä¾¡ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ãŒã€ã“ã®æ©Ÿèƒ½ã¯ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®å¾ŒåŠã§å®Ÿè£…ã—ã¾ã™ã€‚


## ãƒ‡ãƒ¼ã‚¿ã®ã‚½ãƒ¼ãƒˆã¨çµã‚Šè¾¼ã¿

ä»Šã®ã¨ã“ã‚ã€ã‚¢ãƒ—ãƒªã«ã¯ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ‹ãƒ¼ã‚ºã«åŸºã¥ã„ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹æ–¹æ³•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€Cloud Firestoreã®é«˜åº¦ãªã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚

ã™ã¹ã¦ã®ã€Œç‚¹å¿ƒï¼ˆDim Sumï¼‰ã€ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚’å–å¾—ã™ã‚‹ç°¡å˜ãªã‚¯ã‚¨ãƒªã®ä¾‹ã‚’æ¬¡ã«ç¤ºã—ã¾ã™ã€‚

```js
let filteredQuery = query(collection('restaurants'), where('category', '==', 'Dim Sum');
```

ãã®åå‰ãŒç¤ºã™ã‚ˆã†ã«ã€`where()` ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã¤ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚ã“ã®å ´åˆã€ã‚«ãƒ†ã‚´ãƒªãŒã€Œç‚¹å¿ƒï¼ˆDim Sumï¼‰ã€ã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ã¿ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚

ã“ã®ã‚¢ãƒ—ãƒªã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¤‡æ•°ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒã‚§ãƒ¼ãƒ³ã—ã¦ã€ã€Œã‚µãƒ³ãƒ•ãƒ©ãƒ³ã‚·ã‚¹ã‚³ã®ãƒ”ã‚¶ã€ã‚„ã€Œäººæ°—ã®ã‚ã‚‹ãƒ­ã‚µãƒ³ã‚¼ãƒ«ã‚¹ã®ã‚·ãƒ¼ãƒ•ãƒ¼ãƒ‰ã€ãªã©ã®ç‰¹å®šã®ã‚¯ã‚¨ãƒªã‚’ä½œæˆã§ãã¾ã™ã€‚

ãã‚Œã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸè¤‡æ•°ã®æ¡ä»¶ã«åŸºã¥ã„ã¦ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ã‚¯ã‚¨ãƒªã‚’ä½œæˆã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œæˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

1. `src/components/FriendlyEats.Data.js` ã‚’é–‹ãã¾ã™
1. `getFilteredRestaurants`ã‚’æ¢ã—ã¾ã™
1. é–¢æ•°å…¨ä½“ã‚’ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«ç½®ãæ›ãˆã¾ã™

[FriendlyEats.Data.js](https://github.com/isamu/FriendlyEats-vue3/blob/master/src/components/FriendlyEats.Data.js#L32-L36.js)

```js
export const getFilteredRestaurants = (filters) => {
  let q = collection(db, 'restaurants');

  if (filters.category !== 'Any') {
    q = query(q, where('category', '==', filters.category));
  }

  if (filters.city !== 'Any') {
    q = query(q, where('city', '==', filters.city));
  }

  if (filters.price !== 'Any') {
    q = query(q, where('price', '==', filters.price));
  }

  if (filters.sort === 'Rating') {
    q = query(q, orderBy('avgRating', 'desc'));
  } else if (filters.sort === 'Reviews') {
    q = query(q, orderBy('numRatings', 'desc'));
  }
  return q;
};
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã¯ã€è¤‡æ•°ã®`where`ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨1ã¤ã®`orderBy`ã‚’è¿½åŠ ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã«åŸºã¥ã„ã¦è¤‡åˆã‚¯ã‚¨ãƒªã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ã‚¯ã‚¨ãƒªã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ã¿ã‚’è¿”ã—ã¾ã™ã€‚

ã“ã“ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§FriendlyEatsã‚¢ãƒ—ãƒªã‚’æ›´æ–°ã—ã€ä¾¡æ ¼ã‚„éƒ½å¸‚ãªã©ã®ã‚«ãƒ†ã‚´ãƒªã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã—ã‚ˆã†ã¨ã—ã¦ã‚‚ã€ã¾ã å®Œå…¨ã«ã¯å‹•ãã¾ã›ã‚“ã€‚æ¤œç´¢çµæœã¯ã€ŒYour Cloud Firestore has no documents in /restaurants/ã€ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã¾ãŸã€ãƒ–ãƒ©ã‚¦ã‚¶ã®JavaScriptã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«æ¬¡ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

```sh
The query requires an index. You can create it here: https://console.firebase.google.com/project/.../database/firestore/indexes?create_index=...
```

ã“ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ç†ç”±ã¯ã€Cloud Firestoreã§ã»ã¨ã‚“ã©ã®è¤‡åˆã‚¯ã‚¨ãƒªã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå¿…è¦ãªã®ã§ã™ãŒã€ãã‚Œã‚’ã¾ã ç”¨æ„ã—ã¦ã„ãªã„ãŸã‚ã§ã™ã€‚ã‚¯ã‚¨ãƒªã®éš›ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å¿…è¦ã¨ã™ã‚‹ã“ã¨ã§ã€è¦æ¨¡ãŒæ‹¡å¤§ã—ã¦ã‚‚Cloud Firestoreã‚’é«˜é€Ÿã«ä¿ã¡ã¾ã™ã€‚

æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¿…è¦ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

## Cloud Firestoreã«indexã‚’è¿½åŠ 

ã‚¢ãƒ—ãƒªå†…ã®ã™ã¹ã¦ã®ãƒ‘ã‚¹ã‚’æ¢ç´¢ã—ã€å„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆãƒªãƒ³ã‚¯ã‚’ãŸã©ã‚‹å¿…è¦ãŒãªã„å ´åˆã¯ã€Firebase CLIã‚’ä½¿ç”¨ã—ã¦å¤šæ•°ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¸€åº¦ã«ç°¡å˜ã«å±•é–‹ã§ãã¾ã™ã€‚

ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã€firestore.indexes.jsonãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«å¿…è¦ãªã™ã¹ã¦ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒè¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚

[firestore.indexes.json](https://github.com/isamu/FriendlyEats-vue3/blob/master/firestore.indexes.json)

```json
{
 "indexes": [
   {
     "collectionGroup": "restaurants",
     "queryScope": "COLLECTION",
     "fields": [
       { "fieldPath": "city", "order": "ASCENDING" },
       { "fieldPath": "avgRating", "order": "DESCENDING" }
     ]
   },

   ...

 ]
}
```

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã“ã‚Œã‚‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

```sh
firebase deploy --only firestore:indexes
```
æ•°åˆ†å¾Œã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæœ‰åŠ¹ã«ãªã‚Šã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ¶ˆãˆã¾ã™ã€‚


> Tip: Cloud Firestoreã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã”è¦§ãã ã•ã„ã€‚

## ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãè¾¼ã¿
ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›¸ãè¾¼ã¿ã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

ä»Šã¾ã§ã®ã¨ã“ã‚ã€æ›¸ãè¾¼ã¿ã¯ã™ã¹ã¦ã‚¢ãƒˆãƒŸãƒƒã‚¯ã§æ¯”è¼ƒçš„å˜ç´”ã§ã™ã€‚ã‚‚ã—æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã§ã‚‚ã€ãŠãŠã‚€ã­å˜ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å†è©¦è¡Œã‚’ä¿ƒã™ã‹ã€ã§ãªã‘ã‚Œã°ã‚¢ãƒ—ãƒªè‡ªèº«ãŒè‡ªå‹•çš„ã«å†è©¦è¡Œã™ã‚‹ã§ã—ã‚‡ã†ã€‚

ã—ã‹ã—ã€ã“ã®ã‚¢ãƒ—ãƒªã«ã¯ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®è©•ä¾¡ã‚’è¿½åŠ ã—ãŸã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¤šæ•°ã„ã‚‹ãŸã‚ã€èª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿ãŒè¤‡æ•°å›ã‚ã£ãŸå ´åˆã€ãã‚Œã‚‰ã®èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¤ã¾ã‚Šã€æœ€åˆã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒä½œæˆã•ã‚Œãªã‘ã‚Œã°ãªã‚‰ãšã€æ¬¡ã„ã§ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®è©•ä¾¡æ•° `count` ã¨å¹³å‡è©•ä¾¡ `average rating` ã‚’æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã—ã¦ã“ã‚Œã‚‰ã®æ“ä½œã®ã†ã¡ã€ã©ã‚Œã‹1ã¤ãŒå¤±æ•—ã—ã€ä»–ãŒæˆåŠŸã—ãŸå ´åˆã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚ã‚‹éƒ¨åˆ†ã®ãƒ‡ãƒ¼ã‚¿ãŒåˆ¥ã®éƒ¨åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã¨ä¸€è‡´ã—ãªã„ã€çŸ›ç›¾ã—ãŸçŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚

å¹¸ã„ãªã“ã¨ã«ã€Cloud Firestoreã«ã¯ã€å˜ä¸€ã®ã‚¢ãƒˆãƒŸãƒƒã‚¯æ“ä½œã§è¤‡æ•°ã®èª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿ã‚’å¯èƒ½ã«ã™ã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€ã“ã‚Œã«ã‚ˆã‚Šãƒ‡ãƒ¼ã‚¿ã®ä¸€è²«æ€§ã‚’ç¶­æŒã§ãã¾ã™ã€‚

1. `src/components/FriendlyEats.Data.js` ã‚’é–‹ã
1. `addRating` é–¢æ•°ã‚’æ¢ã™
1. é–¢æ•°å…¨ä½“ã‚’ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«ç½®ãæ›ãˆã¾ã™

[FriendlyEats.Data.js](https://github.com/isamu/FriendlyEats-vue3/blob/master/src/components/FriendlyEats.Data.js#L39-L43.js)

```js
export const addRating = (restaurantID, rating) => {
  const restaurantCollection = collection(db, 'restaurants');
  const restaurantDoc = doc(restaurantCollection, restaurantID);
  const newRatingDocument = doc(collection(restaurantDoc, 'ratings'));

  return runTransaction(db, async (transaction) => {
    return transaction.get(restaurantDoc).then(function(doc) {
      const data = doc.data();

      const newAverage =
            (data.numRatings * data.avgRating + rating.rating) /
            (data.numRatings + 1);
      
      transaction.update(restaurantDoc, {
        numRatings: data.numRatings + 1,
        avgRating: newAverage
      });
      return transaction.set(newRatingDocument, rating);
    });
  });
};
```

ä¸Šè¨˜ã®ãƒ–ãƒ­ãƒƒã‚¯ã§ã¯ã€`restaurants`ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®`averageRating`ã¨`ratingCount`ã®æ•°å€¤ã‚’æ›´æ–°ã™ã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚åŒæ™‚ã«ã€`ratings`ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«æ–°ã—ã„`rating`ã‚’è¿½åŠ ã—ã¾ã™ã€‚

>æ³¨ï¼šè©•ä¾¡ã®è¿½åŠ ã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†ã“ã¨ã¯ã€ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®ã‚±ãƒ¼ã‚¹ã§ã¯è‰¯ã„ä½¿ç”¨ä¾‹ã§ã™ã€‚ãŸã ã—ã€å®Ÿé‹ç”¨ã‚¢ãƒ—ãƒªã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹ä¸æ­£æ“ä½œã‚’é¿ã‘ã‚‹ãŸã‚ã«ã€å¹³å‡è©•ä¾¡ã®ç®—å‡ºã¯ä¿¡é ¼ã§ãã‚‹ã‚µãƒ¼ãƒãƒ¼ã§è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚’è¡Œã†è‰¯ã„æ–¹æ³•ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ç›´æ¥è©•ä¾¡ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã€[Cloud Functions](https://firebase.google.com/docs/functions/)ã‚’åˆ©ç”¨ã—ã¦æ–°ã—ã„ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®å¹³å‡è©•ä¾¡ã‚’æ›´æ–°ã™ã‚‹ã“ã¨ã§ã™ã€‚

>è­¦å‘Šï¼šã‚µãƒ¼ãƒãƒ¼ã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒå¤±æ•—ã™ã‚‹ã¨ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚ç¹°ã‚Šè¿”ã—å†å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹ã‚’å¤‰æ›´ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…ã«é…ç½®ã—ãªã„ã§ãã ã•ã„ã€‚

## ãƒ‡ãƒ¼ã‚¿ã‚’å®ˆã‚‹

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®æœ€åˆã«ã€ã‚¢ãƒ—ãƒªã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã«è¨­å®šã—ã€è‡ªç”±ã«èª­ã¿æ›¸ãã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚
å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€æœ›ã¾ã—ããªã„ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚„å¤‰æ›´ã‚’é˜²ããŸã‚ã«ã€ã‚ˆã‚Šãã‚ç´°ã‹ã„ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

1. Firebase console ã‚’é–‹ãã€é–‹ç™º ï¼ Database ã‚’é¸æŠã—ã¾ã™
1. Cloud Firestore ï¼ ãƒ«ãƒ¼ãƒ« ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™
1. `rules_version = '2';` ã‚ˆã‚Šä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«ç½®ãæ›ãˆã¦ã€Œå…¬é–‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™

[firestore.rules](https://github.com/isamu/FriendlyEats-vue3/blob/master/firestore.rules)

```
service cloud.firestore {
  match /databases/{database}/documents {

        // Restaurants:
        //   - Authenticated user can read
        //   - Authenticated user can create/update (for demo)
        //   - Validate updates
        //   - Deletes are not allowed
    match /restaurants/{restaurantId} {
      allow read, create: if request.auth != null;
      allow update: if request.auth != null
                    && request.resource.data.name == resource.data.name
      allow delete: if false;
      
      // Ratings:
      //   - Authenticated user can read
      //   - Authenticated user can create if userId matches
      //   - Deletes and updates are not allowed
      match /ratings/{ratingId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null
                      && request.resource.data.userId == request.auth.uid;
        allow update, delete: if false;
        
        }
    }
  }
}
```

ã“ã‚Œã‚‰ã®ãƒ«ãƒ¼ãƒ«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã—ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒå®‰å…¨ãªå¤‰æ›´ã®ã¿è¡Œãˆã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚ä¾‹ãˆã°ï¼š

- ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°ã§ã¯ã€è©•ä¾¡ã®ã¿ãŒå¤‰æ›´ã§ãã€åå‰ã‚„ãã®ä»–ã®ä¸å¤‰ãªãƒ‡ãƒ¼ã‚¿ã¯å¤‰æ›´ã§ãã¾ã›ã‚“
- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ä¸€è‡´ã™ã‚‹å ´åˆã«ã®ã¿è©•ä¾¡ã‚’ä½œæˆã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãªã‚Šã™ã¾ã—ãŒé˜²æ­¢ã§ãã¾ã™

Firebaseã®Consoleã‚’ä½¿ã†ã‹ã‚ã‚Šã«ã€Firebase CLIã‚’ä½¿ç”¨ã—ã¦ãƒ«ãƒ¼ãƒ«ã‚’Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å±•é–‹ã§ãã¾ã™ã€‚ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®[`firestore.rules`](https://github.com/firebase/friendlyeats-web/blob/master/firestore.rules)ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€ä¸Šè¨˜ã®ãƒ«ãƒ¼ãƒ«ãŒæ—¢ã«å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ«ãƒ¼ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‹ã‚‰Firebaseã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```sh
firebase deploy --only firestore:rules
```

> é‡è¦ï¼šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€[ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://firebase.google.com/docs/firestore/security/get-started)ã‚’ã”è¦§ãã ã•ã„ã€‚

## ãƒ‡ãƒ—ãƒ­ã‚¤

ã¾ãšã€Vueã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚

```sh
npm run build
```

`build/`ä»¥ä¸‹ã«é™çš„ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

ã¤ãã« Cloud Firebase ã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

```sh
firebase deploy --only hosting
```

ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã‚‹ã¨ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸã§ã™ã€‚

```sh
âœ”  Deploy complete!

Project Console: https://console.firebase.google.com/project/friendlyeats-vue/overview
Hosting URL: https://friendlyeats-vue.firebaseapp.com
```

Hosting URLã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¦‹ãˆã¾ã™ï¼

## ã¾ã¨ã‚
ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€Cloud Firestoreã§åŸºæœ¬çš„ãªã€ãã—ã¦é«˜åº¦ãªèª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿ã‚’è¡Œã†æ–¹æ³•ã¨ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã§ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã‚’ä¿è­·ã™ã‚‹æ–¹æ³•ã‚’å­¦ã³ã¾ã—ãŸã€‚

Cloud Firestore ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€æ¬¡ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ã”è¦§ãã ã•ã„:

- [Cloud Firestore å…¥é–€](https://firebase.google.com/docs/firestore/)
- [ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®é¸æŠ](https://firebase.google.com/docs/firestore/manage-data/structure-data)
- [Cloud Firestore ã®ã‚¦ã‚§ãƒ–ã‚µãƒ³ãƒ—ãƒ«](https://firebase.google.com/docs/firestore/client/samples-web)

