---
title: "GraphAI Streaming"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [agent, AI, LLM, Tech, GraphAI]
published: true
publication_name: "singularity"
---

# GraphAI Streamingã«ã¤ã„ã¦

GraphAIã‚’ä½¿ã†ã“ã¨ã§ã€ã‚µãƒ¼ãƒã‚„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå˜ä½“ã§ã®å‡¦ç†ã€ã•ã‚‰ã«ã¯ã‚µãƒ¼ãƒã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®é€£æºã«ã‚ˆã‚‹LLMã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãªã©ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ã‚’é€éçš„ã«æ‰±ã†ã“ã¨ãŒã§ãã¾ã™ã€‚ 

ã“ã“ã§ã€Œé€éçš„ã€ã¨ã„ã†ã®ã¯ã€GraphAIãŒæ¨™æº–ã§ç”¨æ„ã—ã¦ã„ã‚‹Expressã®middlewareã‚„HTTP/Streamingã®Agent Filterã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚µãƒ¼ãƒã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã€ã¾ãŸã¯ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ã‚’æ„è­˜ã™ã‚‹ã“ã¨ãªãåˆ©ç”¨ã§ãã‚‹ã“ã¨ã‚’æŒ‡ã—ã¾ã™ã€‚

ä¸€åº¦å®Ÿè£…ã—ãŸå‡¦ç†ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã‚µãƒ¼ãƒã«å¤‰æ›´ã™ã‚‹å ´åˆã‚„ã€ã‚µãƒ¼ãƒãŒå¤‰æ›´ã•ã‚Œã‚‹å ´åˆã§ã‚‚ã€ã»ã¨ã‚“ã©å®Ÿè£…ã‚’å¤‰ãˆã‚‹ã“ã¨ãªãã€è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã ã‘ã§ç§»è¡ŒãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚ã“ã®æŸ”è»Ÿæ€§ã«ã‚ˆã‚Šã€é–‹ç™ºè€…ã¯ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ã®å®Ÿè£…ã«ç…©ã‚ã•ã‚Œã‚‹ã“ã¨ãªãã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã«é›†ä¸­ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

# Streamingå‡¦ç†ã®æ¦‚è¦

1. **ãƒ‡ãƒ¼ã‚¿ã®é€æ¬¡å—ã‘æ¸¡ã—**  
   AgentãŒå®Ÿè¡Œä¸­ã€ãƒ‡ãƒ¼ã‚¿ãŒç”Ÿæˆã•ã‚Œã‚‹ãŸã³ã«ã€callbacké–¢æ•°ã‚’é€šã˜ã¦Agentãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«æ¸¡ã•ã‚Œã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã¯ä¸€æ‹¬ã§å‡¦ç†ã•ã‚Œã‚‹ã®ã§ã¯ãªãã€é€æ¬¡callbacké–¢æ•°ãŒå‘¼ã°ã‚Œã€ãã®éƒ½åº¦å‡¦ç†ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

2. **callbacké–¢æ•°å†…ã§ã®å‡¦ç†**  
   callbacké–¢æ•°ã§ã¯ã€Contextã‹ã‚‰`nodeId`ã€`agentId`ã€`data`ã¨ã„ã£ãŸæƒ…å ±ã‚’å—ã‘å–ã‚Šã€ãã‚Œãã‚Œã®ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦å€‹åˆ¥ã®å‡¦ç†ãŒè¡Œã‚ã‚Œã¾ã™ã€‚ä»¥ä¸‹ã¯ã€åˆ©ç”¨ã™ã‚‹ç’°å¢ƒã”ã¨ã®å‡¦ç†ã®ä¾‹ã§ã™ã€‚

   - **ãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆ**  
     callbacké–¢æ•°ã§å—ã‘å–ã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«é€æ¬¡è¡¨ç¤ºã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã®ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

   - **Expressï¼ˆWebã‚µãƒ¼ãƒï¼‰ã®å ´åˆ**  
     callbacké–¢æ•°ã§å—ã‘å–ã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’åŠ å·¥ã—ã€HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚ã“ã®é€æ¬¡å‡¦ç†ã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ãŒç”Ÿæˆã•ã‚Œã‚‹ãŸã³ã«å³åº§ã«å¿œç­”ãŒè¿”ã›ã‚‹ãŸã‚ã€APIã¨ã—ã¦ã®åˆ©ç”¨ã‚·ãƒŠãƒªã‚ªã«ã‚‚é©ã—ã¦ã„ã¾ã™ã€‚

ã“ã®ã‚ˆã†ãªä»•çµ„ã¿ã«ã‚ˆã£ã¦ã€Agentå®Ÿè¡Œä¸­ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã¨è¡¨ç¤ºãƒ»å¿œç­”ãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚



## Agentå†…ã§ã€agentFilterã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™

https://github.com/receptron/graphai/blob/e720821dff1a4f59423dbb02db64aaec3a2a61eb/llm_agents/openai_agent/src/openai_agent.ts#L120-L125


## agentFilter

ã“ã“ã§ã¯ã€Streamingå‡¦ç†ç”¨ã®`agentFilter`ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•° `streamAgentFilterGenerator` ã®ä½¿ã„æ–¹ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚ã“ã®é–¢æ•°ã‚’ä½¿ã†ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ã¯callbacké–¢æ•°ã‚’æŒ‡å®šã™ã‚‹ã ã‘ã§ã€ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å‡¦ç†ã§ãã‚‹`agentFilter`ã‚’å–å¾—ã§ãã¾ã™ã€‚

https://github.com/receptron/graphai/blob/e720821dff1a4f59423dbb02db64aaec3a2a61eb/packages/agent_filters/src/filters/stream.ts#L3-L13

### ä½¿ç”¨æ–¹æ³•

1. **callbacké–¢æ•°ã‚’å®šç¾©ã™ã‚‹**  
   `context`ã¨`data`ã‚’å¼•æ•°ã«å–ã‚‹callbacké–¢æ•°ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®é–¢æ•°ã¯ã€AgentãŒãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹ãŸã³ã«å‘¼ã³å‡ºã•ã‚Œã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã§ãã¾ã™ã€‚

```typescript
   const myCallback = (context, data) => {
     console.log("Data received:", data);
     // å¿…è¦ãªå‡¦ç†ã‚’ã“ã“ã«è¨˜è¿°
   };
```   

2. **streamAgentFilterã‚’å–å¾—ã™ã‚‹**  
   `streamAgentFilterGenerator`ã«callbacké–¢æ•°ã‚’æ¸¡ã™ã“ã¨ã§ã€ãƒ‡ãƒ¼ã‚¿ã‚’é€æ¬¡å‡¦ç†ã™ã‚‹`agentFilter`ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ã“ã®`agentFilter`ã¯ã€AgentãŒå®Ÿè¡Œä¸­ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å‡¦ç†ã—ã¾ã™ã€‚

```
const myAgentFilter = streamAgentFilterGenerator(myCallback);
```

ä»¥ä¸Šã§ã€`streamAgentFilterGenerator`ã‚’ä½¿ã£ãŸagentFilterå‡¦ç†ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯å®Œäº†ã§ã™ã€‚
ã“ã®agentFilterã‚’GraphAIã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®agentFiltersã«æ¸¡ã—ã¾ã™ã€‚
callbacké–¢æ•°ã‚’é€šã˜ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚’é€æ¬¡å‡¦ç†ã™ã‚‹ä»•çµ„ã¿ã‚’ç°¡å˜ã«æ§‹ç¯‰ã§ãã¾ã™ã€‚



## Streamingå‡¦ç†ã«ã¤ã„ã¦

### 1. GraphAIã‚’ç›´æ¥ä½¿ã†å ´åˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰

- AgentFilterçµŒç”±ã®callbacké–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚
- å…¨ä½“ã®çµæœã¯`graphai.run()`ã‹ã‚‰å—ã‘å–ã‚Šã¾ã™ã€‚
- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã¨çµæœã®å‡¦ç†ã¯å®Ÿè£…å´ã§åˆ¶å¾¡ã§ãã‚‹ãŸã‚ã€delimiterã‚„ãƒ‡ãƒ¼ã‚¿å½¢å¼ã«ã¤ã„ã¦ç‰¹ã«è€ƒæ…®ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

### 2. Expressã®å ´åˆ

- HTTPã®ä»•çµ„ã¿ä¸Šã€æ–‡å­—åˆ—ãŒé †æ¬¡é€ã‚‰ã‚Œã¦ãã¾ã™ã€‚
- æ¨™æº–ã§ã¯ã€tokenï¼ˆæ–‡å­—åˆ—ï¼‰ãŒã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§é€æ¬¡æµã‚Œã€çµ‚äº†æ™‚ã«ã¯`__END__`ã¨ã„ã†delimiterã‚’æŒŸã‚“ã§ã€çµæœï¼ˆcontentï¼‰ãŒJSONå½¢å¼ã®æ–‡å­—åˆ—ã§è¿”ã£ã¦ãã¾ã™ã€‚
- Tokenã®å‡¦ç†ã‚„delimiterã€contentã®å‡¦ç†ã¯ã€Expressã«callbacké–¢æ•°ã‚’æ¸¡ã™ã“ã¨ã§å¤‰æ›´å¯èƒ½ã§ã™ã€‚

## expressã®åˆ¶å¾¡

Expressã¯ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚µãƒ¼ãƒã€ãƒãƒ³ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚µãƒ¼ãƒã€ãã—ã¦ä¸¡æ–¹ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã‚µãƒ¼ãƒã®ãã‚Œãã‚Œã«å¯¾å¿œã—ãŸmiddlewareã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚ä¸¡æ–¹ã®ã‚µãƒãƒ¼ãƒˆã‚’ã™ã‚‹middlewareã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€AgentãŒã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã«å¯¾å¿œã—ã¦ã„ã¦ã‚‚ã€HTTPãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é€šã˜ã¦ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã®åˆ¶å¾¡ãŒå¯èƒ½ã§ã™ã€‚

å…·ä½“çš„ã«ã¯ã€HTTPãƒ˜ãƒƒãƒ€ãƒ¼ã®ä»¥ä¸‹ã®æœ‰ç„¡ã«ã‚ˆã£ã¦åˆ¤å®šãŒè¡Œã‚ã‚Œã¾ã™ï¼š

- `Content-Type` ãŒ `text/event-stream` ã§ã‚ã‚‹ã‹ã©ã†ã‹ã§ã™ã€‚



## ä»¥ä¸‹å‚è€ƒã‚½ãƒ¼ã‚¹

- express ã®callbacké–¢æ•°ä¾‹

https://github.com/receptron/graphai-utils/blob/b302835d978ce1017c6e105898431eda28adcbd4/packages/express/src/agents.ts#L122-L135

- expressã®å®Ÿè£…

https://github.com/receptron/graphai-utils/tree/main/packages/express/src

streamAgentFilterGenerator
https://github.com/receptron/graphai/blob/main/packages/agent_filters/src/filters/stream.ts



- httpAgentFilter ã®å®Ÿè£…(GraphAI Agentã®agent Filterå½¢å¼ã®clinet)

https://github.com/receptron/graphai/blob/main/packages/agent_filters/src/filters/http_client.ts